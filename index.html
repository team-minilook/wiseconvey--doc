<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weraser - AI Knowledge Platform</title>
    <link rel="stylesheet" href="assets/shared.css">
    <style>
        /* Notion-inspired Clean Design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #ffffff;
            color: #37352f;
            line-height: 1.5;
        }
        
        /* Layout Structure */
        .weraser-app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Navigation Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 45px;
            background: #ffffff;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 18px;
        }
        
        .nav-icon:hover {
            background: #f1f1ef;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: #37352f;
            margin-left: 12px;
        }
        
        .breadcrumb-separator {
            color: #a4a4a2;
            margin: 0 4px;
        }
        
        .breadcrumb-item {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .breadcrumb-item:hover {
            background: #f1f1ef;
        }
        
        .breadcrumb-current {
            font-weight: 500;
        }
        
        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-action {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .header-action:hover {
            background: #f1f1ef;
        }
        
        /* Main Content Area */
        .app-body {
            display: flex;
            width: 100%;
            margin-top: 45px;
            height: calc(100vh - 45px);
        }
        
        /* Sidebar - 2 Level Navigation */
        .sidebar {
            width: 260px;
            background: #fbfbfa;
            border-right: 1px solid #e9e9e7;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .back-button:hover {
            background: #e9e9e7;
        }
        
        .sidebar-section {
            padding: 16px;
        }
        
        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            color: #a4a4a2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .icon-button {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #a4a4a2;
        }
        
        .icon-button:hover {
            background: #e9e9e7;
            color: #37352f;
        }
        
        /* Project List */
        .project-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .project-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-item:hover {
            background: #f1f1ef;
        }
        
        .project-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .project-icon {
            font-size: 16px;
        }
        
        .project-name {
            font-size: 14px;
            font-weight: 500;
            color: #37352f;
        }
        
        .project-meta {
            display: flex;
            gap: 12px;
            margin-left: 24px;
            font-size: 12px;
            color: #a4a4a2;
        }
        
        .doc-count, .chat-count {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Chat List */
        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .chat-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .chat-item:hover {
            background: #f1f1ef;
        }
        
        .chat-item.active {
            background: #e9e9e7;
        }
        
        .chat-title {
            font-size: 14px;
            font-weight: 500;
            color: #37352f;
            margin-bottom: 2px;
        }
        
        .chat-preview {
            font-size: 12px;
            color: #a4a4a2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 11px;
            color: #a4a4a2;
        }
        
        .empty-state {
            text-align: center;
            padding: 24px;
            color: #a4a4a2;
        }
        
        .text-button {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            color: #37352f;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .text-button:hover {
            background: #f1f1ef;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }
        
        .chat-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-header-title {
            font-size: 16px;
            font-weight: 600;
            color: #37352f;
        }
        
        .chat-header-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-button {
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            border: none;
            background: transparent;
            color: #787774;
        }
        
        .action-button:hover {
            background: #f1f1ef;
            color: #37352f;
        }
        
        .action-button.active {
            background: #e9e9e7;
            color: #37352f;
        }
        
        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            margin-bottom: 24px;
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            background: #f1f1ef;
        }
        
        .message-avatar--ai {
            background: linear-gradient(135deg, #0066FF, #00D4AA);
            color: white;
        }
        
        .message-sender {
            font-size: 14px;
            font-weight: 500;
            color: #37352f;
        }
        
        .message-time {
            font-size: 12px;
            color: #a4a4a2;
        }
        
        .message-content {
            margin-left: 36px;
        }
        
        .message-edit-wrapper {
            position: relative;
        }
        
        .message-text {
            font-size: 14px;
            line-height: 1.6;
            color: #37352f;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .message-text[contenteditable="true"] {
            background: #f7f6f3;
            outline: 2px solid #0066FF;
            outline-offset: 2px;
        }
        
        .edit-button {
            position: absolute;
            right: -30px;
            top: 8px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            background: #ffffff;
            border: 1px solid #e9e9e7;
        }
        
        .message:hover .edit-button {
            opacity: 1;
        }
        
        .thinking-process {
            margin-top: 8px;
            padding: 8px;
            background: #f7f6f3;
            border-radius: 6px;
            font-size: 13px;
            color: #787774;
        }
        
        .thinking-header {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            user-select: none;
        }
        
        .thinking-content {
            margin-top: 8px;
            padding-left: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        
        .reference-card {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f7f6f3;
            border-radius: 6px;
            font-size: 12px;
            color: #0066FF;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reference-card:hover {
            background: #e9e9e7;
        }
        
        /* Chat Input */
        .chat-input-wrapper {
            padding: 16px;
            border-top: 1px solid #e9e9e7;
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .chat-input-field {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chat-input-field:focus {
            border-color: #0066FF;
        }
        
        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #0066FF;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .send-button:hover {
            background: #0052CC;
        }
        
        .send-button:disabled {
            background: #e9e9e7;
            cursor: not-allowed;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #37352f;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .modal-close:hover {
            background: #f1f1ef;
        }
        
        /* File Tree for Documents */
        .file-tree {
            padding: 12px;
            background: #f7f6f3;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tree-item {
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .tree-item:hover {
            background: #e9e9e7;
        }
        
        .tree-folder {
            font-weight: 500;
        }
        
        .tree-file {
            margin-left: 20px;
            color: #787774;
        }
        
        /* Document Tree in Sidebar */
        .document-tree {
            margin-top: 8px;
            font-size: 13px;
        }
        
        .doc-category {
            margin-bottom: 8px;
        }
        
        .doc-category-header {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .doc-category-header:hover {
            background: #e9e9e7;
        }
        
        .doc-category-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .doc-category.expanded .doc-category-icon {
            transform: rotate(90deg);
        }
        
        .doc-category-label {
            flex: 1;
            font-weight: 500;
            color: #37352f;
        }
        
        .doc-category-count {
            font-size: 11px;
            color: #a4a4a2;
            background: #f1f1ef;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .doc-category-type {
            font-size: 10px;
            color: #787774;
            margin-left: 4px;
        }
        
        .doc-items {
            display: none;
            margin-left: 12px;
            margin-top: 4px;
        }
        
        .doc-category.expanded .doc-items {
            display: block;
        }
        
        .doc-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            color: #787774;
        }
        
        .doc-item:hover {
            background: #e9e9e7;
            color: #37352f;
        }
        
        .doc-item-icon {
            font-size: 12px;
        }
        
        .doc-item-name {
            flex: 1;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .doc-folder {
            margin-bottom: 4px;
        }
        
        .doc-folder-header {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .doc-folder-header:hover {
            background: #e9e9e7;
        }
        
        .doc-folder-files {
            display: none;
            margin-left: 16px;
        }
        
        .doc-folder.expanded .doc-folder-files {
            display: block;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #a4a4a2;
        }
        
        .welcome-content {
            text-align: center;
        }
        
        .welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .welcome-title {
            color: #37352f;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
<div class="weraser-app">
    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <div class="nav-icon" onclick="toggleSidebar()" title="ì‚¬ì´ë“œë°” í† ê¸€">
                <span>â˜°</span>
            </div>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-current">í”„ë¡œì íŠ¸</span>
            </div>
        </div>
        <div class="header-right">
            <div class="header-action" onclick="goToAdmin()">
                ê´€ë¦¬ì
            </div>
            <div class="header-action" onclick="showProfile()">
                ë‚´ í”„ë¡œí•„
            </div>
        </div>
    </header>
    
    <!-- Main Body -->
    <div class="app-body">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Dynamic content loaded here -->
        </aside>
        
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dynamic content loaded here -->
        </main>
    </div>
</div>

<!-- Removed document modal as documents are now in LNB -->

<script src="assets/shared.js"></script>
<script>
    // State management
    let currentView = 'projects'; // 'projects' or 'chats'
    let currentProject = null;
    let currentChat = null;
    let showThinkingProcess = true;
    
    // Mock data for projects and chats
    let projects = [
        {
            id: 'proj1',
            name: 'H-Line ìˆ˜ì¶œ í”„ë¡œì íŠ¸',
            documentCount: 24,
            chats: [
                { id: 'chat1', title: 'HS ì½”ë“œ ë¶„ë¥˜ ê²€í† ', lastMessage: 'ì˜¬í•´ ê´€ì„¸ìœ¨ì€...', time: 'ë°©ê¸ˆ ì „' },
                { id: 'chat2', title: 'ìš´ì†¡ ê²½ë¡œ ìµœì í™”', lastMessage: 'ë¶€ì‚°í•­ ê²½ìœ ì‹œ...', time: '2ì‹œê°„ ì „' }
            ],
            documents: {
                organization: [
                    { type: 'folder', name: 'ê³„ì•½ì„œ', files: ['2024_H-Line_ê³„ì•½ì„œ.pdf', 'ë¶€ì†í•©ì˜ì„œ.docx'] },
                    { type: 'folder', name: 'ê´€ì„¸ìë£Œ', files: ['HS_ì½”ë“œ_ë¶„ë¥˜í‘œ.xlsx', 'ê´€ì„¸ìœ¨í‘œ.pdf'] },
                    { type: 'folder', name: 'ë²•ë¬´ìë£Œ', files: ['ìˆ˜ì¶œì…ë²•ë ¹.pdf', 'FTA_ê°€ì´ë“œ.pdf'] }
                ],
                personal: [
                    { type: 'file', name: 'í”„ë¡œì íŠ¸_ìš”ì•½.pptx' },
                    { type: 'file', name: 'ë¯¸íŒ…_ë…¸íŠ¸.docx' },
                    { type: 'folder', name: 'ê°œì¸ë©”ëª¨', files: ['ê²€í† ì‚¬í•­.txt', 'ì²´í¬ë¦¬ìŠ¤íŠ¸.xlsx'] }
                ]
            }
        },
        {
            id: 'proj2',
            name: '2024 ì—°ê°„ ê³„íš',
            documentCount: 15,
            chats: [
                { id: 'chat3', title: 'Q1 ëª©í‘œ ì„¤ì •', lastMessage: '1ë¶„ê¸° ë§¤ì¶œ ëª©í‘œëŠ”...', time: 'ì–´ì œ' }
            ],
            documents: {
                organization: [
                    { type: 'folder', name: 'íšŒì‚¬ì •ì±…', files: ['ì¸ì‚¬ê·œì •.pdf', 'ë³µë¬´ê·œì •.pdf'] },
                    { type: 'file', name: '2024_ì‚¬ì—…ê³„íšì„œ.pdf' }
                ],
                personal: [
                    { type: 'folder', name: 'ë¶„ê¸°ë³„ ê³„íš', files: ['Q1_ê³„íš.docx', 'Q2_ê³„íš.docx'] },
                    { type: 'file', name: 'ì—°ê°„_ëª©í‘œ.xlsx' }
                ]
            }
        },
        {
            id: 'proj3',
            name: 'ì‹ ê·œ ê³ ê°ì‚¬ ëŒ€ì‘',
            documentCount: 8,
            chats: [],
            documents: {
                organization: [
                    { type: 'file', name: 'íšŒì‚¬ì†Œê°œì„œ.pdf' },
                    { type: 'file', name: 'í¬íŠ¸í´ë¦¬ì˜¤.pdf' }
                ],
                personal: [
                    { type: 'file', name: 'ì œì•ˆì„œ_ì´ˆì•ˆ.pptx' },
                    { type: 'file', name: 'ê²¬ì ì„œ.xlsx' }
                ]
            }
        }
    ];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        WeraserCore.init('phase1');
        renderSidebar();
        showWelcomeScreen();
    });
    
    // Render document tree
    function renderDocumentTree(documents) {
        if (!documents) return '<div class="empty-state" style="padding: 12px; font-size: 12px;">ë¬¸ì„œê°€ ì—†ìŠµë‹ˆë‹¤</div>';
        
        const orgCount = countDocuments(documents.organization);
        const personalCount = countDocuments(documents.personal);
        
        return `
            <div class="doc-category expanded" id="orgDocs">
                <div class="doc-category-header" onclick="toggleDocCategory('orgDocs')">
                    <span class="doc-category-icon">â–¼</span>
                    <span class="doc-category-label">ğŸ¢ ì¡°ì§ ë¬¸ì„œ</span>
                    <span class="doc-category-count">${orgCount}</span>
                </div>
                <div class="doc-items">
                    ${renderDocumentItems(documents.organization)}
                </div>
            </div>
            <div class="doc-category" id="personalDocs">
                <div class="doc-category-header" onclick="toggleDocCategory('personalDocs')">
                    <span class="doc-category-icon">â–¶</span>
                    <span class="doc-category-label">ğŸ‘¤ ê°œì¸ ë¬¸ì„œ</span>
                    <span class="doc-category-count">${personalCount}</span>
                </div>
                <div class="doc-items">
                    ${renderDocumentItems(documents.personal)}
                </div>
            </div>
        `;
    }
    
    // Render document items
    function renderDocumentItems(items) {
        if (!items || items.length === 0) return '<div style="padding: 4px 8px; color: #a4a4a2; font-size: 11px;">ë¹„ì–´ ìˆìŒ</div>';
        
        return items.map(item => {
            if (item.type === 'folder') {
                return `
                    <div class="doc-folder" id="folder-${item.name}">
                        <div class="doc-folder-header" onclick="toggleDocFolder('folder-${item.name}')">
                            <span class="doc-category-icon">â–¶</span>
                            <span>ğŸ“</span>
                            <span class="doc-item-name">${item.name}</span>
                        </div>
                        <div class="doc-folder-files">
                            ${item.files.map(file => `
                                <div class="doc-item" onclick="showDocument('${file}')">
                                    <span class="doc-item-icon">${getFileIcon(file)}</span>
                                    <span class="doc-item-name">${file}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else {
                return `
                    <div class="doc-item" onclick="showDocument('${item.name}')">
                        <span class="doc-item-icon">${getFileIcon(item.name)}</span>
                        <span class="doc-item-name">${item.name}</span>
                    </div>
                `;
            }
        }).join('');
    }
    
    // Count documents
    function countDocuments(items) {
        if (!items) return 0;
        let count = 0;
        items.forEach(item => {
            if (item.type === 'folder') {
                count += item.files.length;
            } else {
                count += 1;
            }
        });
        return count;
    }
    
    // Get file icon based on extension
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'pdf': 'ğŸ“•',
            'docx': 'ğŸ“„',
            'doc': 'ğŸ“„',
            'xlsx': 'ğŸ“Š',
            'xls': 'ğŸ“Š',
            'pptx': 'ğŸ“Š',
            'ppt': 'ğŸ“Š',
            'txt': 'ğŸ“',
            'csv': 'ğŸ“Š'
        };
        return icons[ext] || 'ğŸ“„';
    }
    
    // Toggle document category
    function toggleDocCategory(categoryId) {
        const category = document.getElementById(categoryId);
        category.classList.toggle('expanded');
    }
    
    // Toggle document folder
    function toggleDocFolder(folderId) {
        const folder = document.getElementById(folderId);
        folder.classList.toggle('expanded');
        const icon = folder.querySelector('.doc-category-icon');
        icon.textContent = folder.classList.contains('expanded') ? 'â–¼' : 'â–¶';
    }
    
    // Render sidebar based on current view
    function renderSidebar() {
        const sidebar = document.getElementById('sidebar');
        
        if (currentView === 'projects') {
            // Show project list
            sidebar.innerHTML = `
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        <span>í”„ë¡œì íŠ¸</span>
                        <button class="icon-button" onclick="createNewProject()" title="ìƒˆ í”„ë¡œì íŠ¸">+</button>
                    </div>
                    <div class="project-list" id="projectList">
                        ${projects.map(project => `
                            <div class="project-item" onclick="selectProject('${project.id}')">
                                <div class="project-item-header">
                                    <span class="project-icon">ğŸ“</span>
                                    <span class="project-name">${project.name}</span>
                                </div>
                                <div class="project-meta">
                                    <span class="doc-count">ğŸ“„ ${project.documentCount}ê°œ</span>
                                    <span class="chat-count">ğŸ’¬ ${project.chats.length}ê°œ</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else if (currentView === 'chats' && currentProject) {
            // Show chat list for selected project
            const project = projects.find(p => p.id === currentProject);
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div class="back-button" onclick="backToProjects()" title="í”„ë¡œì íŠ¸ ëª©ë¡ìœ¼ë¡œ">
                        <span>â†</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 600;">${project.name}</div>
                        <div style="font-size: 12px; color: #a4a4a2;">ğŸ“„ ${project.documentCount}ê°œ ë¬¸ì„œ</div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        <span>ì±„íŒ… ì„¸ì…˜</span>
                        <button class="icon-button" onclick="createNewChat('${project.id}')" title="ìƒˆ ì±„íŒ…">+</button>
                    </div>
                    <div class="chat-list" id="chatList">
                        ${project.chats.length > 0 ? project.chats.map(chat => `
                            <div class="chat-item ${currentChat === chat.id ? 'active' : ''}" onclick="selectChat('${project.id}', '${chat.id}')">
                                <div class="chat-title">${chat.title}</div>
                                <div class="chat-preview">${chat.lastMessage}</div>
                                <div class="chat-time">${chat.time}</div>
                            </div>
                        `).join('') : `
                            <div class="empty-state">
                                <div style="font-size: 32px; margin-bottom: 8px;">ğŸ’¬</div>
                                <div style="font-size: 14px;">ì±„íŒ…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                                <button class="btn btn--primary btn--small" style="margin-top: 12px;" onclick="createNewChat('${project.id}')">ì²« ì±„íŒ… ì‹œì‘</button>
                            </div>
                        `}
                    </div>
                </div>
                <div class="sidebar-section" style="border-top: 1px solid #e9e9e7;">
                    <div class="sidebar-title">
                        <span>ë¬¸ì„œ ê´€ë¦¬</span>
                        <div style="display: flex; gap: 4px;">
                            <button class="icon-button" onclick="uploadDocument()" title="ê°œì¸ ë¬¸ì„œ ì—…ë¡œë“œ">ğŸ“¤</button>
                            <button class="icon-button" onclick="importFromOrg()" title="ì¡°ì§ ë¬¸ì„œ ì„í¬íŠ¸">ğŸ“¥</button>
                        </div>
                    </div>
                    <div class="document-tree" id="sidebarDocumentTree">
                        ${renderDocumentTree(project.documents)}
                    </div>
                </div>
            `;
        }
    }
    
    // Navigate to project's chat list
    function selectProject(projectId) {
        currentProject = projectId;
        currentView = 'chats';
        renderSidebar();
        updateBreadcrumb();
        
        // Show project welcome or last chat
        const project = projects.find(p => p.id === projectId);
        if (project.chats.length > 0) {
            selectChat(projectId, project.chats[0].id);
        } else {
            showProjectWelcome(projectId);
        }
    }
    
    // Back to project list
    function backToProjects() {
        currentView = 'projects';
        currentProject = null;
        currentChat = null;
        renderSidebar();
        updateBreadcrumb();
        showWelcomeScreen();
    }
    
    // Update breadcrumb based on current view
    function updateBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        
        if (currentView === 'projects') {
            breadcrumb.innerHTML = '<span class="breadcrumb-current">í”„ë¡œì íŠ¸</span>';
        } else if (currentView === 'chats' && currentProject) {
            const project = projects.find(p => p.id === currentProject);
            const chat = currentChat ? project.chats.find(c => c.id === currentChat) : null;
            
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="backToProjects()">í”„ë¡œì íŠ¸</span>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item" onclick="selectProject('${project.id}')">${project.name}</span>
                ${chat ? `
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">${chat.title}</span>
                ` : ''}
            `;
        }
    }
    
    // Select a chat
    function selectChat(projectId, chatId) {
        currentChat = chatId;
        
        // Update active state in sidebar
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        const chatElement = event.currentTarget;
        if (chatElement && chatElement.classList) {
            chatElement.classList.add('active');
        }
        
        updateBreadcrumb();
        loadChatMessages(chatId);
    }
    
    // Show welcome screen
    function showWelcomeScreen() {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <div class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">ğŸ¤–</div>
                    <h2 class="welcome-title">Weraserì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤</h2>
                    <p>í”„ë¡œì íŠ¸ë¥¼ ì„ íƒí•˜ì—¬ ì‹œì‘í•˜ì„¸ìš”</p>
                </div>
            </div>
        `;
    }
    
    // Show project welcome
    function showProjectWelcome(projectId) {
        const project = projects.find(p => p.id === projectId);
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <div class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">ğŸ“</div>
                    <h2 class="welcome-title">${project.name}</h2>
                    <p style="margin-bottom: 16px;">ë¬¸ì„œ ${project.documentCount}ê°œ ì¤€ë¹„ë¨</p>
                    <button class="btn btn--primary" onclick="createNewChat('${projectId}')">ì±„íŒ… ì‹œì‘í•˜ê¸°</button>
                </div>
            </div>
        `;
    }
    
    // Load chat messages
    function loadChatMessages(chatId) {
        const project = projects.find(p => p.id === currentProject);
        const chat = project.chats.find(c => c.id === chatId);
        
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-title">${chat.title}</div>
                </div>
                <div class="chat-header-actions">
                    <button class="action-button" onclick="renameChat()">ì´ë¦„ ë³€ê²½</button>
                    <button class="action-button" onclick="deleteChat()">ì‚­ì œ</button>
                    <button class="action-button ${showThinkingProcess ? 'active' : ''}" onclick="toggleThinkingMode()">
                        ì‚¬ê³  ê³¼ì •
                    </button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>
            <div class="chat-input-wrapper">
                <div class="chat-input-container">
                    <textarea 
                        class="chat-input-field" 
                        id="chatInput" 
                        placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..."
                        onkeydown="handleInputKeydown(event)"
                        oninput="adjustInputHeight(this)"
                    ></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        â¤
                    </button>
                </div>
            </div>
        `;
        
        // Load sample messages
        addSampleMessages();
    }
    
    // Add sample messages
    function addSampleMessages() {
        const messagesDiv = document.getElementById('chatMessages');
        
        // Sample 1: User asks for discount rate
        const userMessage1 = createMessage('user', 'ì‘ë…„ H-Line í”„ë¡œì íŠ¸ì˜ ìµœì¢… í• ì¸ìœ¨ê³¼ ê·¼ê±° ìë£Œë¥¼ ì°¾ì•„ì¤˜');
        messagesDiv.appendChild(userMessage1);
        
        // Sample 1: AI response with references
        const aiMessage1 = createMessage('ai', 
            `ì‘ë…„ H-Line í”„ë¡œì íŠ¸ì˜ ìµœì¢… í• ì¸ìœ¨ì€ **15%**ì˜€ìŠµë‹ˆë‹¤.
            
            ê·¼ê±° ìë£Œ:
            1. 2023ë…„ 4ë¶„ê¸° ê³„ì•½ì„œ (p.12): "ìµœì¢… í•©ì˜ í• ì¸ìœ¨ 15% ì ìš©"
            2. ê°€ê²© í˜‘ìƒ íšŒì˜ë¡ (2023.10.15): "ê²½ìŸì‚¬ ëŒ€ë¹„ ìš°ìœ„ í™•ë³´ë¥¼ ìœ„í•œ ì „ëµì  í• ì¸"
            3. CFO ìŠ¹ì¸ ë¬¸ì„œ: "15% í• ì¸ ìŠ¹ì¸, ë‹¨ ìµœì†Œ ë¬¼ëŸ‰ ë³´ì¥ ì¡°ê±´"`,
            true,
            ['2023_Q4_ê³„ì•½ì„œ.pdf', 'ê°€ê²©í˜‘ìƒ_íšŒì˜ë¡.docx', 'CFO_ìŠ¹ì¸ë¬¸ì„œ.pdf']
        );
        messagesDiv.appendChild(aiMessage1);
        
        // Sample 2: User asks for comparison
        const userMessage2 = createMessage('user', 'ìµœê·¼ 3ë…„ê°„ ì£¼ìš” í’ˆëª©ì˜ ê´€ì„¸ìœ¨ ë³€í™”ë¥¼ í‘œë¡œ ì •ë¦¬í•´ì¤˜');
        messagesDiv.appendChild(userMessage2);
        
        // Sample 2: AI response with table
        const aiMessage2 = createMessage('ai', 
            `ìµœê·¼ 3ë…„ê°„ ì£¼ìš” í’ˆëª©ì˜ ê´€ì„¸ìœ¨ ë³€í™”ë¥¼ ì •ë¦¬í–ˆìŠµë‹ˆë‹¤:

<table style="width: 100%; border-collapse: collapse; margin: 12px 0;">
<thead>
<tr style="background: #f7f6f3;">
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: left;">í’ˆëª©ëª…</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">HS ì½”ë“œ</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">2022ë…„</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">2023ë…„</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">2024ë…„</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">ë³€í™”ìœ¨</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #e9e9e7; padding: 8px;">ì „ìë¶€í’ˆ</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">8542.31</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">8%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">4%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center; color: #22c55e;">â†“ 50%</td>
</tr>
<tr style="background: #fbfbfa;">
<td style="border: 1px solid #e9e9e7; padding: 8px;">ê¸°ê³„ë¶€í’ˆ</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">8481.10</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">3%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center; color: #22c55e;">â†“ 40%</td>
</tr>
<tr>
<td style="border: 1px solid #e9e9e7; padding: 8px;">í™”í•™ì œí’ˆ</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">3901.10</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6.5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6.5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6.5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center; color: #a4a4a2;">â†’ 0%</td>
</tr>
</tbody>
</table>

**ì£¼ìš” ë³€í™” ì‚¬í•­:**
- FTA ì²´ê²°ë¡œ ì¸í•œ ë‹¨ê³„ì  ê´€ì„¸ ì¸í•˜ ì§„í–‰ ì¤‘
- ì „ìë¶€í’ˆê³¼ ê¸°ê³„ë¶€í’ˆì˜ ê´€ì„¸ìœ¨ì´ í¬ê²Œ ê°ì†Œ
- í™”í•™ì œí’ˆì€ ë³€ë™ ì—†ì´ ìœ ì§€`,
            true,
            ['ê´€ì„¸ìœ¨í‘œ_2022.xlsx', 'ê´€ì„¸ìœ¨í‘œ_2023.xlsx', 'ê´€ì„¸ìœ¨í‘œ_2024.xlsx', 'FTA_ì˜í–¥ë¶„ì„.pdf']
        );
        messagesDiv.appendChild(aiMessage2);
        
        // Sample 3: User asks for trend analysis
        const userMessage3 = createMessage('user', 'ì˜¬í•´ ìƒë°˜ê¸° ìˆ˜ì¶œ ì‹¤ì ì„ ê·¸ë˜í”„ë¡œ ë³´ì—¬ì£¼ê³  ë¶„ì„í•´ì¤˜');
        messagesDiv.appendChild(userMessage3);
        
        // Sample 3: AI response with chart
        const aiMessage3 = createMessage('ai', 
            `2024ë…„ ìƒë°˜ê¸° ìˆ˜ì¶œ ì‹¤ì ì„ ë¶„ì„í–ˆìŠµë‹ˆë‹¤:

<div style="background: #f7f6f3; padding: 16px; border-radius: 8px; margin: 12px 0;">
<canvas id="exportChart" style="max-width: 100%; height: 300px;"></canvas>
</div>

**ğŸ“Š ìƒë°˜ê¸° ìˆ˜ì¶œ ì‹¤ì  ë¶„ì„**

**ì›”ë³„ ì‹¤ì  (ë‹¨ìœ„: ë°±ë§Œ ë‹¬ëŸ¬)**
- 1ì›”: $45.2M (ì „ë…„ ë™ê¸° ëŒ€ë¹„ +12%)
- 2ì›”: $42.8M (ì „ë…„ ë™ê¸° ëŒ€ë¹„ +8%)
- 3ì›”: $48.6M (ì „ë…„ ë™ê¸° ëŒ€ë¹„ +15%)
- 4ì›”: $51.3M (ì „ë…„ ë™ê¸° ëŒ€ë¹„ +18%)
- 5ì›”: $49.7M (ì „ë…„ ë™ê¸° ëŒ€ë¹„ +14%)
- 6ì›”: $53.9M (ì „ë…„ ë™ê¸° ëŒ€ë¹„ +22%)

**í•µì‹¬ ì¸ì‚¬ì´íŠ¸:**
1. **ì„±ì¥ ì¶”ì„¸**: ìƒë°˜ê¸° ì „ì²´ +14.8% ì„±ì¥
2. **ìµœê³  ì‹¤ì **: 6ì›” $53.9Mìœ¼ë¡œ ì—­ëŒ€ ìµœê³  ê¸°ë¡
3. **ì£¼ìš” ìš”ì¸**: 
   - ì‹ ê·œ ì‹œì¥ ì§„ì¶œ (ë™ë‚¨ì•„ 3ê°œêµ­)
   - ê¸°ì¡´ ê³ ê°ì‚¬ ì£¼ë¬¸ëŸ‰ ì¦ê°€
   - í™˜ìœ¨ íš¨ê³¼ (+3% ê¸°ì—¬)

<div style="background: #e3f2fd; padding: 12px; border-left: 4px solid #0066FF; margin: 12px 0;">
ğŸ’¡ **ê¶Œì¥ ì‚¬í•­**: í•˜ë°˜ê¸°ì—ë„ ì„±ì¥ì„¸ ìœ ì§€ë¥¼ ìœ„í•´ ì¬ê³  í™•ë³´ ë° ë¬¼ë¥˜ ë¼ì¸ ì ê²€ í•„ìš”
</div>`,
            true,
            ['ìˆ˜ì¶œì‹¤ì _2024_ìƒë°˜ê¸°.xlsx', 'ì‹œì¥ë¶„ì„_ë³´ê³ ì„œ.pdf', 'í™˜ìœ¨ë™í–¥_ë¶„ì„.pdf']
        );
        messagesDiv.appendChild(aiMessage3);
        
        // Initialize chart after message is added
        setTimeout(() => {
            const canvas = document.getElementById('exportChart');
            if (canvas && canvas.getContext) {
                drawExportChart(canvas);
            }
        }, 100);
    }
    
    // Draw export chart
    function drawExportChart(canvas) {
        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth;
        const height = canvas.height = 300;
        
        // Sample data
        const data = [45.2, 42.8, 48.6, 51.3, 49.7, 53.9];
        const labels = ['1ì›”', '2ì›”', '3ì›”', '4ì›”', '5ì›”', '6ì›”'];
        const maxValue = 60;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Draw axes
        ctx.strokeStyle = '#e9e9e7';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(40, 20);
        ctx.lineTo(40, height - 40);
        ctx.lineTo(width - 20, height - 40);
        ctx.stroke();
        
        // Draw bars
        const barWidth = (width - 80) / data.length * 0.6;
        const barSpacing = (width - 80) / data.length;
        
        data.forEach((value, index) => {
            const barHeight = (value / maxValue) * (height - 80);
            const x = 40 + index * barSpacing + barSpacing * 0.2;
            const y = height - 40 - barHeight;
            
            // Bar gradient
            const gradient = ctx.createLinearGradient(0, y, 0, height - 40);
            gradient.addColorStop(0, '#0066FF');
            gradient.addColorStop(1, '#00D4AA');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Value label
            ctx.fillStyle = '#37352f';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`$${value}M`, x + barWidth / 2, y - 5);
            
            // Month label
            ctx.fillText(labels[index], x + barWidth / 2, height - 25);
        });
        
        // Y-axis labels
        ctx.fillStyle = '#787774';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
            const value = (maxValue / 5) * i;
            const y = height - 40 - (i * (height - 80) / 5);
            ctx.fillText(`$${value}M`, 35, y + 4);
        }
        
        // Title
        ctx.fillStyle = '#37352f';
        ctx.font = 'bold 14px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('2024ë…„ ìƒë°˜ê¸° ì›”ë³„ ìˆ˜ì¶œ ì‹¤ì ', 50, 15);
    }
    
    // Create message element
    function createMessage(type, text, hasThinking = false, references = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message--${type}`;
        
        const now = new Date();
        const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        
        if (type === 'user') {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar">ë‚˜</div>
                    <div class="message-sender">ì‚¬ìš©ì</div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content">
                    <div class="message-edit-wrapper">
                        <div class="message-text" contenteditable="false">${text}</div>
                        <button class="edit-button" onclick="editMessage(this)">âœï¸</button>
                    </div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar message-avatar--ai">AI</div>
                    <div class="message-sender">Weraser AI</div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content">
                    <div class="message-text">${text}</div>
                    ${hasThinking && showThinkingProcess ? `
                        <div class="thinking-process">
                            <div class="thinking-header" onclick="toggleThinking(this)">
                                <span>â–¶</span>
                                <span>ì‚¬ê³  ê³¼ì •</span>
                            </div>
                            <div class="thinking-content" style="display: none;">
                                1. ì§ˆë¬¸ ë¶„ì„: "H-Line í”„ë¡œì íŠ¸" + "í• ì¸ìœ¨" í‚¤ì›Œë“œ ì¶”ì¶œ<br>
                                2. ë¬¸ì„œ ê²€ìƒ‰: 2023ë…„ ê³„ì•½ì„œ, íšŒì˜ë¡ ê²€ìƒ‰<br>
                                3. ì •ë³´ ì¶”ì¶œ: í• ì¸ìœ¨ 15% í™•ì¸<br>
                                4. êµì°¨ ê²€ì¦: CFO ìŠ¹ì¸ ë¬¸ì„œì—ì„œ ì¬í™•ì¸<br>
                                5. ë‹µë³€ ìƒì„±: ì •í™•í•œ ìˆ˜ì¹˜ì™€ ì¶œì²˜ ëª…ì‹œ
                            </div>
                        </div>
                    ` : ''}
                    ${references.length > 0 ? references.map(ref => `
                        <span class="reference-card" onclick="showDocument('${ref}')">
                            ğŸ“„ ${ref}
                        </span>
                    `).join('') : ''}
                </div>
            `;
        }
        
        return messageDiv;
    }
    
    
    // Toggle sidebar
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    }
    
    // Create new project
    function createNewProject() {
        const name = prompt('í”„ë¡œì íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:');
        if (name) {
            const newProject = {
                id: `proj${projects.length + 1}`,
                name: name,
                documentCount: 0,
                chats: [],
                documents: []
            };
            projects.push(newProject);
            renderSidebar();
            WeraserCore.ui.showNotification(`í”„ë¡œì íŠ¸ '${name}' ìƒì„±ë¨`, 'success');
        }
    }
    
    // Create new chat
    function createNewChat(projectId) {
        const chatName = prompt('ì±„íŒ… ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', 'ìƒˆ ì±„íŒ…');
        if (chatName) {
            const project = projects.find(p => p.id === projectId);
            const newChat = {
                id: `chat${Date.now()}`,
                title: chatName,
                lastMessage: '',
                time: 'ë°©ê¸ˆ ì „'
            };
            project.chats.push(newChat);
            
            // Update view
            currentChat = newChat.id;
            renderSidebar();
            loadChatMessages(newChat.id);
            WeraserCore.ui.showNotification(`ì±„íŒ… '${chatName}' ìƒì„±ë¨`, 'success');
        }
    }
    
    // Message editing
    function editMessage(button) {
        const wrapper = button.closest('.message-edit-wrapper');
        const messageText = wrapper.querySelector('.message-text');
        
        if (messageText.contentEditable === 'false') {
            // Start editing
            messageText.contentEditable = 'true';
            messageText.focus();
            button.textContent = 'âœ“';
            
            // Fade subsequent AI messages
            let nextMessage = wrapper.closest('.message').nextElementSibling;
            while (nextMessage) {
                if (nextMessage.classList.contains('message--ai')) {
                    nextMessage.style.opacity = '0.3';
                }
                nextMessage = nextMessage.nextElementSibling;
            }
        } else {
            // Finish editing and regenerate
            messageText.contentEditable = 'false';
            button.textContent = 'âœï¸';
            
            // Remove faded messages and regenerate AI response
            let nextMessage = wrapper.closest('.message').nextElementSibling;
            while (nextMessage && nextMessage.classList.contains('message--ai')) {
                const temp = nextMessage.nextElementSibling;
                nextMessage.remove();
                nextMessage = temp;
            }
            
            // Generate new AI response
            generateAIResponse(messageText.textContent);
        }
    }
    
    // Generate AI response
    async function generateAIResponse(message) {
        const messagesDiv = document.getElementById('chatMessages');
        
        // Show typing indicator
        WeraserCore.ui.showNotification('AIê°€ ë‹µë³€ì„ ìƒì„±ì¤‘...', 'info');
        
        // Simulate AI response
        setTimeout(() => {
            const aiMessage = createMessage('ai', 
                `"${message}"ì— ëŒ€í•œ ë‹µë³€ì…ë‹ˆë‹¤.
                
                ê´€ë ¨ ë¬¸ì„œë¥¼ ê²€ìƒ‰í•˜ì—¬ ì •í™•í•œ ì •ë³´ë¥¼ ì œê³µí•´ë“œë¦¬ê² ìŠµë‹ˆë‹¤.`,
                true,
                []
            );
            messagesDiv.appendChild(aiMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }, 1000);
    }
    
    // Toggle thinking process
    function toggleThinking(element) {
        const content = element.nextElementSibling;
        const toggle = element.querySelector('span:first-child');
        
        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
            toggle.textContent = 'â–¼';
        } else {
            content.style.display = 'none';
            toggle.textContent = 'â–¶';
        }
    }
    
    // Toggle thinking mode
    function toggleThinkingMode() {
        showThinkingProcess = !showThinkingProcess;
        const button = event.currentTarget;
        button.classList.toggle('active');
        WeraserCore.ui.showNotification(
            showThinkingProcess ? 'ì‚¬ê³  ê³¼ì • í‘œì‹œ ì¼œì§' : 'ì‚¬ê³  ê³¼ì • í‘œì‹œ êº¼ì§',
            'info'
        );
    }
    
    // Send message
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        
        // Add user message
        const messagesDiv = document.getElementById('chatMessages');
        const userMessage = createMessage('user', message);
        messagesDiv.appendChild(userMessage);
        
        // Clear input
        input.value = '';
        input.style.height = 'auto';
        
        // Disable send button
        document.getElementById('sendButton').disabled = true;
        
        // Generate AI response
        await generateAIResponse(message);
        
        // Enable send button
        document.getElementById('sendButton').disabled = false;
        
        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Handle input keydown
    function handleInputKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }
    
    // Adjust input height
    function adjustInputHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // Upload document
    function uploadDocument() {
        const input = document.createElement('input');
        input.type = 'file';
        input.multiple = true;
        input.accept = '.pdf,.docx,.xlsx,.csv,.txt,.pptx';
        input.onchange = async (e) => {
            const files = e.target.files;
            WeraserCore.ui.showNotification(`${files.length}ê°œ ë¬¸ì„œ ì—…ë¡œë“œ ì¤‘...`, 'info');
            
            // Add to current project's documents
            const project = projects.find(p => p.id === currentProject);
            for (const file of files) {
                project.documents.push({ type: 'file', name: file.name });
                project.documentCount++;
            }
            
            renderSidebar();
            setTimeout(() => {
                WeraserCore.ui.showNotification(`${files.length}ê°œ ë¬¸ì„œ ì—…ë¡œë“œ ì™„ë£Œ`, 'success');
            }, 1000);
        };
        input.click();
    }
    
    // Import from organization
    function importFromOrg() {
        WeraserCore.ui.showNotification('ì¡°ì§ ê³µìœ  ì €ì¥ì†Œì—ì„œ ë¬¸ì„œ ì„ íƒ í™”ë©´ í‘œì‹œ', 'info');
        // TODO: Show organization document picker
    }
    
    // Show document
    function showDocument(filename) {
        WeraserCore.ui.showNotification(`ë¬¸ì„œ '${filename}' ì—´ê¸°`, 'info');
        // TODO: Open document viewer
    }
    
    // Close modal
    function closeModal(modalId) {
        document.getElementById(modalId).classList.remove('show');
    }
    
    // Rename chat
    function renameChat() {
        const project = projects.find(p => p.id === currentProject);
        const chat = project.chats.find(c => c.id === currentChat);
        const newName = prompt('ìƒˆ ì±„íŒ… ì´ë¦„:', chat.title);
        if (newName && newName !== chat.title) {
            chat.title = newName;
            renderSidebar();
            updateBreadcrumb();
            WeraserCore.ui.showNotification('ì±„íŒ… ì´ë¦„ ë³€ê²½ë¨', 'success');
        }
    }
    
    // Delete chat
    function deleteChat() {
        if (confirm('ì´ ì±„íŒ…ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            const project = projects.find(p => p.id === currentProject);
            const chatIndex = project.chats.findIndex(c => c.id === currentChat);
            project.chats.splice(chatIndex, 1);
            
            // Show welcome or first chat
            if (project.chats.length > 0) {
                selectChat(currentProject, project.chats[0].id);
            } else {
                currentChat = null;
                showProjectWelcome(currentProject);
            }
            
            renderSidebar();
            WeraserCore.ui.showNotification('ì±„íŒ… ì‚­ì œë¨', 'success');
        }
    }
    
    // Go to admin
    function goToAdmin() {
        window.location.href = 'admin.html';
    }
    
    // Show profile
    function showProfile() {
        WeraserCore.ui.showNotification('í”„ë¡œí•„ í™”ë©´ í‘œì‹œ', 'info');
    }
</script>
</body>
</html>