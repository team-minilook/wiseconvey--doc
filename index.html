<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Weraser - AI Knowledge Platform</title>
    <link rel="stylesheet" href="assets/shared.css">
    <link rel="stylesheet" href="gemini-api.css">
    <!-- Core Systems -->
    <script src="vector-engine.js"></script>
    
    <!-- Gemini API Integration -->
    <script src="config-secure.js"></script>
    <script src="gemini-direct.js"></script>
    <script src="gemini-mock.js"></script>
    <script src="gemini-smart.js"></script>
    <script src="gemini-api.js"></script>
    <style>
        /* Hide Gemini API Modal - No modal needed */
        .gemini-api-modal {
            display: none !important;
        }
        
        /* Notion-inspired Clean Design */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Noto Sans KR', sans-serif;
            background: #ffffff;
            color: #37352f;
            line-height: 1.5;
        }
        
        /* Layout Structure */
        .weraser-app {
            display: flex;
            height: 100vh;
            overflow: hidden;
        }
        
        /* Navigation Header */
        .app-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 45px;
            background: #ffffff;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            padding: 0 16px;
            z-index: 100;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .nav-icon {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 18px;
        }
        
        .nav-icon:hover {
            background: #f1f1ef;
        }
        
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 14px;
            color: #37352f;
            margin-left: 12px;
        }
        
        .breadcrumb-separator {
            color: #a4a4a2;
            margin: 0 4px;
        }
        
        .breadcrumb-item {
            cursor: pointer;
            padding: 4px 8px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .breadcrumb-item:hover {
            background: #f1f1ef;
        }
        
        .breadcrumb-current {
            font-weight: 500;
        }
        
        .header-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .header-action {
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .header-action:hover {
            background: #f1f1ef;
        }
        
        /* Main Content Area */
        .app-body {
            display: flex;
            width: 100%;
            margin-top: 45px;
            height: calc(100vh - 45px);
        }
        
        /* Sidebar - 2 Level Navigation */
        .sidebar {
            width: 260px;
            background: #fbfbfa;
            border-right: 1px solid #e9e9e7;
            display: flex;
            flex-direction: column;
            position: relative;
        }
        
        .sidebar-header {
            padding: 12px 16px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .back-button {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .back-button:hover {
            background: #e9e9e7;
        }
        
        .sidebar-section {
            padding: 16px;
        }
        
        .sidebar-title {
            font-size: 12px;
            font-weight: 600;
            color: #a4a4a2;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .icon-button {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            background: transparent;
            color: #a4a4a2;
        }
        
        .icon-button:hover {
            background: #e9e9e7;
            color: #37352f;
        }
        
        /* Project List */
        .project-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .project-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .project-item:hover {
            background: #f1f1ef;
        }
        
        .project-item-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
        }
        
        .project-icon {
            font-size: 16px;
        }
        
        .project-name {
            font-size: 14px;
            font-weight: 500;
            color: #37352f;
        }
        
        .project-meta {
            display: flex;
            gap: 12px;
            margin-left: 24px;
            font-size: 12px;
            color: #a4a4a2;
        }
        
        .doc-count, .chat-count {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        /* Chat List */
        .chat-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .chat-item {
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }
        
        .chat-item:hover {
            background: #f1f1ef;
        }
        
        .chat-item.active {
            background: #e9e9e7;
        }
        
        .chat-title {
            font-size: 14px;
            font-weight: 500;
            color: #37352f;
            margin-bottom: 2px;
        }
        
        .chat-preview {
            font-size: 12px;
            color: #a4a4a2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .chat-time {
            position: absolute;
            top: 8px;
            right: 12px;
            font-size: 11px;
            color: #a4a4a2;
        }
        
        .empty-state {
            text-align: center;
            padding: 24px;
            color: #a4a4a2;
        }
        
        .text-button {
            width: 100%;
            padding: 8px 12px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 14px;
            color: #37352f;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .text-button:hover {
            background: #f1f1ef;
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #ffffff;
        }
        
        .chat-header {
            padding: 12px 20px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .chat-header-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .chat-header-title {
            font-size: 16px;
            font-weight: 600;
            color: #37352f;
        }
        
        .chat-header-actions {
            display: flex;
            gap: 8px;
        }
        
        .action-button {
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            border: none;
            background: transparent;
            color: #787774;
        }
        
        .action-button:hover {
            background: #f1f1ef;
            color: #37352f;
        }
        
        .action-button.active {
            background: #e9e9e7;
            color: #37352f;
        }
        
        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .message {
            margin-bottom: 24px;
        }
        
        /* Loading Spinner */
        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            margin: 8px 0;
            background: #f7f6f3;
            border-radius: 8px;
            animation: fadeIn 0.3s ease;
        }
        
        .typing-dots {
            display: flex;
            gap: 4px;
        }
        
        .typing-dot {
            width: 8px;
            height: 8px;
            background: #787774;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        
        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }
        
        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0.8);
                opacity: 0.5;
            }
            40% {
                transform: scale(1);
                opacity: 1;
            }
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .message-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }
        
        .message-avatar {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: 600;
            background: #f1f1ef;
        }
        
        .message-avatar--ai {
            background: linear-gradient(135deg, #0066FF, #00D4AA);
            color: white;
        }
        
        .message-sender {
            font-size: 14px;
            font-weight: 500;
            color: #37352f;
        }
        
        .message-time {
            font-size: 12px;
            color: #a4a4a2;
        }
        
        .message-content {
            margin-left: 36px;
        }
        
        .message-edit-wrapper {
            position: relative;
        }
        
        .message-text {
            font-size: 14px;
            line-height: 1.6;
            color: #37352f;
            padding: 8px;
            border-radius: 6px;
            transition: background 0.2s;
        }
        
        .message-text[contenteditable="true"] {
            background: #f7f6f3;
            outline: 2px solid #0066FF;
            outline-offset: 2px;
        }
        
        .edit-button {
            position: absolute;
            right: -30px;
            top: 8px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            cursor: pointer;
            opacity: 0;
            transition: all 0.2s;
            background: #ffffff;
            border: 1px solid #e9e9e7;
        }
        
        .message:hover .edit-button {
            opacity: 1;
        }
        
        .thinking-process {
            margin-top: 8px;
            padding: 8px;
            background: #f7f6f3;
            border-radius: 6px;
            font-size: 13px;
            color: #787774;
        }
        
        .thinking-header {
            display: flex;
            align-items: center;
            gap: 4px;
            cursor: pointer;
            user-select: none;
        }
        
        .thinking-content {
            margin-top: 8px;
            padding-left: 16px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }
        
        .reference-card {
            display: inline-block;
            margin-top: 8px;
            padding: 8px 12px;
            background: #f7f6f3;
            border-radius: 6px;
            font-size: 12px;
            color: #0066FF;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .reference-card:hover {
            background: #e9e9e7;
        }
        
        /* Chat Input */
        .chat-input-wrapper {
            padding: 16px;
            border-top: 1px solid #e9e9e7;
        }
        
        .chat-input-container {
            display: flex;
            gap: 8px;
            align-items: flex-end;
        }
        
        .chat-input-field {
            flex: 1;
            min-height: 40px;
            max-height: 120px;
            padding: 10px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 8px;
            font-size: 14px;
            resize: none;
            outline: none;
            transition: border-color 0.2s;
        }
        
        .chat-input-field:focus {
            border-color: #0066FF;
        }
        
        .send-button {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            background: #0066FF;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .send-button:hover {
            background: #0052CC;
        }
        
        .send-button:disabled {
            background: #e9e9e7;
            cursor: not-allowed;
        }
        
        /* Modals */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 24px;
            max-width: 600px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 600;
            color: #37352f;
        }
        
        .modal-close {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .modal-close:hover {
            background: #f1f1ef;
        }
        
        /* File Tree for Documents */
        .file-tree {
            padding: 12px;
            background: #f7f6f3;
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .tree-item {
            padding: 4px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .tree-item:hover {
            background: #e9e9e7;
        }
        
        .tree-folder {
            font-weight: 500;
        }
        
        .tree-file {
            margin-left: 20px;
            color: #787774;
        }
        
        /* Document Tree in Sidebar */
        .document-tree {
            margin-top: 8px;
            font-size: 13px;
        }
        
        /* Storage Progress Bar */
        .storage-progress {
            margin: 12px;
            padding: 12px;
            background: #f7f7f5;
            border-radius: 6px;
            border: 1px solid #e9e9e7;
        }
        
        .storage-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .storage-title {
            font-size: 12px;
            font-weight: 600;
            color: #37352f;
        }
        
        .storage-info {
            font-size: 11px;
            color: #787774;
        }
        
        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9e9e7;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #0066FF, #00D4AA);
            border-radius: 4px;
            transition: width 0.3s ease;
        }
        
        .progress-warning {
            background: linear-gradient(90deg, #FFA500, #FF6B6B);
        }
        
        .storage-details {
            display: flex;
            justify-content: space-between;
            margin-top: 6px;
            font-size: 10px;
            color: #a4a4a2;
        }
        
        /* Document sync status */
        .sync-status {
            margin-left: 4px;
            font-size: 10px;
            opacity: 0.6;
            animation: rotate 2s linear infinite;
        }
        
        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        /* Document artifact view */
        .artifact-panel {
            position: fixed;
            right: 20px;
            top: 80px;
            bottom: 20px;
            width: 400px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            display: none;
            flex-direction: column;
            z-index: 1000;
        }
        
        .artifact-panel.visible {
            display: flex;
        }
        
        .artifact-header {
            padding: 16px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .artifact-title {
            font-weight: 600;
            color: #37352f;
        }
        
        .artifact-close {
            cursor: pointer;
            padding: 4px;
            color: #787774;
        }
        
        .artifact-content {
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            font-size: 14px;
            line-height: 1.6;
            color: #37352f;
        }
        
        .artifact-meta {
            padding: 12px 16px;
            background: #f7f7f5;
            border-top: 1px solid #e9e9e7;
            font-size: 12px;
            color: #787774;
        }
        
        /* Document Add Dropdown */
        .document-add-container {
            position: relative;
            display: inline-block;
        }
        
        .document-add-btn {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 12px;
            background: #2383e2;
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-family: inherit;
        }
        
        .document-add-btn:hover {
            background: #1976d2;
        }
        
        .dropdown-arrow {
            font-size: 10px;
            transition: transform 0.2s;
        }
        
        .document-add-btn.active .dropdown-arrow {
            transform: rotate(180deg);
        }
        
        .document-add-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: white;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            min-width: 180px;
            z-index: 1000;
            display: none;
            margin-top: 4px;
        }
        
        .document-add-dropdown.show {
            display: block;
        }
        
        .dropdown-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 12px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 13px;
        }
        
        .dropdown-item:hover {
            background: #f1f1ef;
        }
        
        .dropdown-item:first-child {
            border-radius: 6px 6px 0 0;
        }
        
        .dropdown-item:last-child {
            border-radius: 0 0 6px 6px;
        }
        
        .dropdown-item span:first-child {
            font-size: 16px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-container {
            background: white;
            border-radius: 8px;
            box-shadow: none !important;
            max-width: 90vw;
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            padding: 16px 20px;
            border-bottom: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .modal-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #787774;
        }
        
        .modal-close:hover {
            background: #f1f1ef;
        }
        
        .modal-content {
            padding: 20px;
            overflow-y: auto;
        }
        
        .modal-footer {
            padding: 16px 20px;
            border-top: 1px solid #e9e9e7;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        /* Quota Navigation Styles */
        .modal-header-content {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            width: 100%;
        }

        .quota-navigation {
            margin-top: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #787774;
        }

        .quota-bar-container {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .quota-bar {
            width: 100px;
            height: 4px;
            background: #e9e9e7;
            border-radius: 2px;
            position: relative;
            overflow: hidden;
        }

        .quota-fill {
            height: 100%;
            background: linear-gradient(90deg, #22c55e 0%, #eab308 70%, #ef4444 90%);
            transition: width 0.3s ease;
            border-radius: 2px;
        }

        .quota-text {
            font-size: 11px;
            color: #787774;
            white-space: nowrap;
        }

        .quota-info {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: #787774;
        }

        .quota-label {
            font-weight: 500;
        }

        /* Upload Tips Styles */
        .upload-tips {
            background: #f8f8f7;
            border-radius: 6px;
            padding: 12px;
            margin-bottom: 20px;
        }

        .tip-item {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 4px;
            font-size: 12px;
            color: #787774;
        }

        .tip-item:last-child {
            margin-bottom: 0;
        }

        .tip-icon {
            font-size: 14px;
        }

        /* Directory Selection Styles */
        .directory-options {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .directory-list .directory-item {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
            margin-bottom: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .directory-list .directory-item:hover {
            background: #f8f8f7;
            border-color: #d3d3d1;
        }

        .directory-list .directory-item input[type="radio"] {
            margin-right: 8px;
        }

        .directory-list .directory-item label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            flex: 1;
        }

        .dir-count {
            color: #787774;
            font-size: 11px;
            margin-left: auto;
        }

        .new-directory-section {
            border-top: 1px solid #e9e9e7;
            padding-top: 16px;
        }

        .new-directory-input {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        /* File Upload Section Styles */
        .file-upload-section {
            margin-top: 20px;
        }

        .selected-files {
            margin-top: 16px;
            padding: 12px;
            background: #f8f8f7;
            border-radius: 6px;
        }

        .file-list {
            max-height: 150px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 8px;
            background: white;
            border-radius: 4px;
            margin-bottom: 4px;
            font-size: 12px;
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-size {
            color: #787774;
        }

        /* Selection Info Styles */
        .selection-info {
            display: flex;
            align-items: center;
            gap: 16px;
            font-size: 12px;
            color: #787774;
        }

        .quota-status {
            font-weight: 500;
        }

        .quota-status.warning {
            color: #eab308;
        }

        .quota-status.error {
            color: #ef4444;
        }

        .quota-status.success {
            color: #22c55e;
        }

        /* Organization Document Browser Specific Styles */
        .org-browser-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
            background: #fafafa;
        }

        /* Fix for browser tips styling */
        .browser-tips {
            background: #f8f8f7 !important;
            padding: 12px !important;
            margin-bottom: 16px !important;
            border-radius: 6px !important;
            font-size: 12px !important;
            color: #787774 !important;
        }

        /* Ensure modal content doesn't overflow */
        .modal-content {
            overflow-y: auto;
            max-height: calc(90vh - 140px);
        }

        /* Fix directory selector styling */
        .directory-selector h4, .directory-selector h5 {
            margin: 0 0 8px 0;
            font-size: 14px;
            font-weight: 600;
            color: #37352f;
        }

        /* Drag and drop enhancement */
        .file-upload-area:hover {
            border-color: #3b82f6;
            background: #f8faff;
        }

        .file-upload-area.dragover {
            border-color: #3b82f6 !important;
            background: #eff6ff !important;
            border-style: solid !important;
        }

        /* Modal z-index fix */
        .modal-overlay {
            z-index: 10000 !important;
        }

        /* Button style improvements */
        .btn-primary {
            transition: all 0.2s ease;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }

        .org-folder {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            border-bottom: 1px solid #f1f1f1;
            background: white;
            margin-bottom: 1px;
        }

        .org-folder:hover {
            background: #f8f8f7;
        }

        .org-folder-content {
            background: #f9f9f9;
            border-left: 3px solid #e9e9e7;
            margin-left: 16px;
        }

        .org-file {
            display: flex;
            align-items: center;
            padding: 6px 12px;
            margin: 1px 0;
            background: white;
            cursor: pointer;
            border-radius: 3px;
        }

        .org-file:hover {
            background: #f0f0f0;
        }

        .org-file input[type="checkbox"] {
            margin-right: 8px;
            transform: scale(1.1);
        }

        .org-file .file-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .org-file .file-name {
            flex: 1;
            font-size: 13px;
            font-weight: 500;
            color: #37352f;
        }

        .org-file .file-meta {
            font-size: 11px;
            color: #787774;
            margin-left: 8px;
        }

        .folder-icon {
            margin-right: 8px;
            font-size: 16px;
        }

        .folder-name {
            flex: 1;
            font-size: 14px;
            font-weight: 600;
            color: #37352f;
        }

        .folder-count {
            font-size: 11px;
            color: #787774;
            margin-left: 8px;
        }

        /* Selection Info Enhancement */
        .selection-summary {
            display: flex;
            gap: 16px;
            align-items: center;
        }

        .quota-warnings {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .quota-warning {
            font-size: 12px;
            color: #ef4444;
            font-weight: 500;
        }

        .quota-help {
            font-size: 11px;
            color: #787774;
        }

        /* Import Button Enhancement */
        #importBtn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #importBtn:not(:disabled):hover {
            background: #2563eb;
            transform: translateY(-1px);
        }
        
        .modal-buttons {
            display: flex;
            gap: 8px;
        }
        
        .btn-primary {
            background: #2383e2;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-primary:hover {
            background: #1976d2;
        }
        
        .btn-primary:disabled {
            background: #a4a4a2;
            cursor: not-allowed;
        }
        
        .btn-secondary {
            background: white;
            color: #37352f;
            border: 1px solid #e9e9e7;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .btn-secondary:hover {
            background: #f1f1ef;
        }
        
        /* Organization Document Browser */
        .org-browser-tree {
            font-size: 13px;
        }
        
        .org-folder, .org-file {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 6px 8px;
            cursor: pointer;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        .org-folder:hover, .org-file:hover {
            background: #f1f1ef;
        }
        
        .org-folder-content {
            margin-left: 20px;
        }
        
        .folder-name {
            flex: 1;
        }
        
        .folder-count, .file-meta {
            color: #787774;
            font-size: 11px;
        }
        
        .file-checkbox {
            margin-right: 4px;
        }
        
        .selection-info {
            font-size: 12px;
            color: #787774;
            display: flex;
            gap: 12px;
        }
        
        /* Personal Upload Modal */
        .upload-step h4 {
            margin: 0 0 16px 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        .upload-step h5 {
            margin: 0 0 8px 0;
            font-size: 13px;
            font-weight: 600;
        }
        
        .directory-selector {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        .directory-list {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        
        .directory-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border: 1px solid #e9e9e7;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .directory-item:hover {
            background: #f1f1ef;
            border-color: #2383e2;
        }
        
        .directory-item.selected {
            background: #e6f7ff;
            border-color: #2383e2;
        }
        
        .dir-count {
            color: #787774;
            font-size: 11px;
            margin-left: auto;
        }
        
        .selected-directory {
            background: #f7f7f5;
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 16px;
            font-size: 13px;
        }
        
        .file-upload-area {
            border: 2px dashed #e9e9e7;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .file-upload-area:hover, .file-upload-area.dragover {
            border-color: #2383e2;
            background: #f8fbff;
        }
        
        .upload-icon {
            font-size: 32px;
            margin-bottom: 12px;
        }
        
        .upload-text {
            font-size: 14px;
            color: #37352f;
            margin-bottom: 8px;
        }
        
        .upload-formats {
            font-size: 12px;
            color: #787774;
        }
        
        .selected-files {
            text-align: left;
        }
        
        .file-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 0;
            border-bottom: 1px solid #f1f1ef;
        }
        
        .file-item:last-child {
            border-bottom: none;
        }
        
        .file-name {
            flex: 1;
            font-size: 13px;
        }
        
        .file-size {
            color: #787774;
            font-size: 11px;
        }
        
        /* Upload quota and validation */
        .quota-warning {
            color: #ef4444;
            font-size: 11px;
            font-weight: 600;
        }
        
        .upload-info {
            font-size: 12px;
            color: #787774;
            display: flex;
            gap: 12px;
            align-items: center;
        }
        
        .capacity-bar {
            width: 100%;
            height: 6px;
            background: #f1f1ef;
            border-radius: 3px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .capacity-fill {
            height: 100%;
            background: #2383e2;
            transition: all 0.3s ease;
        }
        
        .capacity-fill.warning {
            background: #f59e0b;
        }
        
        .capacity-fill.danger {
            background: #ef4444;
        }
        
        .validation-error {
            color: #ef4444;
            font-size: 12px;
            margin-top: 8px;
            padding: 8px;
            background: #fef2f2;
            border-radius: 4px;
            border: 1px solid #fecaca;
        }
        
        /* Stop button for chat */
        .stop-button {
            padding: 6px 12px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin-left: 8px;
        }
        
        .stop-button:hover {
            background: #dc2626;
        }
        
        .doc-category {
            margin-bottom: 8px;
        }
        
        .doc-category-header {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            user-select: none;
        }
        
        .doc-category-header:hover {
            background: #e9e9e7;
        }
        
        .doc-category-icon {
            font-size: 12px;
            transition: transform 0.2s;
        }
        
        .doc-category.expanded .doc-category-icon {
            transform: rotate(90deg);
        }
        
        .doc-category-label {
            flex: 1;
            font-weight: 500;
            color: #37352f;
        }
        
        .doc-category-count {
            font-size: 11px;
            color: #a4a4a2;
            background: #f1f1ef;
            padding: 2px 6px;
            border-radius: 10px;
        }
        
        .doc-category-type {
            font-size: 10px;
            color: #787774;
            margin-left: 4px;
        }
        
        .doc-items {
            display: none;
            margin-left: 12px;
            margin-top: 4px;
        }
        
        .doc-category.expanded .doc-items {
            display: block;
        }
        
        .doc-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
            color: #787774;
        }
        
        .doc-item:hover {
            background: #e9e9e7;
            color: #37352f;
        }
        
        .doc-item-icon {
            font-size: 12px;
        }
        
        .doc-item-name {
            flex: 1;
            font-size: 12px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .doc-folder {
            margin-bottom: 4px;
        }
        
        .doc-folder-header {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .doc-folder-header:hover {
            background: #e9e9e7;
        }
        
        .doc-folder-files {
            display: none;
            margin-left: 16px;
        }
        
        .doc-folder.expanded .doc-folder-files {
            display: block;
        }
        
        /* Welcome Screen */
        .welcome-screen {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #a4a4a2;
        }
        
        .welcome-content {
            text-align: center;
        }
        
        .welcome-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .welcome-title {
            color: #37352f;
            margin-bottom: 8px;
        }
    </style>
</head>
<body>
<div class="weraser-app">
    <!-- Header -->
    <header class="app-header">
        <div class="header-left">
            <div class="nav-icon" onclick="toggleSidebar()" title="사이드바 토글">
                <span>☰</span>
            </div>
            <div class="breadcrumb" id="breadcrumb">
                <span class="breadcrumb-current">프로젝트</span>
            </div>
        </div>
        <div class="header-right">
            <div class="header-action" onclick="goToAdmin()">
                관리자
            </div>
            <div class="header-action" onclick="showProfile()">
                내 프로필
            </div>
        </div>
    </header>
    
    <!-- Main Body -->
    <div class="app-body">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <!-- Dynamic content loaded here -->
        </aside>
        
        <!-- Main Content -->
        <main class="main-content" id="mainContent">
            <!-- Dynamic content loaded here -->
        </main>
    </div>
</div>

<!-- Removed document modal as documents are now in LNB -->

<script src="assets/shared.js"></script>
<script>
    // State management
    let currentView = 'projects'; // 'projects' or 'chats'
    let currentProject = null;
    let currentChat = null;
    let showThinkingProcess = true;
    
    // User roles and permissions
    const userRoles = {
        ADMIN: 'admin',
        MANAGER: 'manager',
        USER: 'user'
    };
    
    // Current user (mock - in production, this would come from authentication)
    let currentUser = {
        id: 'user-001',
        name: '김대리',
        email: 'kim@company.com',
        role: userRoles.ADMIN  // Change to test different roles
    };
    
    // Organization directory structure
    let organizationDirectories = [
        {
            id: 'org-dir-001',
            name: '계약서',
            path: '/조직문서/계약서',
            type: 'organization',
            permissions: ['admin', 'manager'],
            createdBy: 'admin',
            createdAt: '2024-01-15',
            fileCount: 3,
            children: []
        },
        {
            id: 'org-dir-002',
            name: '관세자료',
            path: '/조직문서/관세자료',
            type: 'organization',
            permissions: ['admin', 'manager'],
            createdBy: 'admin',
            createdAt: '2024-01-10',
            fileCount: 4,
            children: []
        },
        {
            id: 'org-dir-003',
            name: '회의록',
            path: '/조직문서/회의록',
            type: 'organization',
            permissions: ['admin', 'manager', 'user'],
            createdBy: 'admin',
            createdAt: '2024-01-05',
            fileCount: 5,
            children: []
        }
    ];
    
    // Source quota constants (in MB)
    const QUOTA_LIMITS = {
        MAX_FILE_SIZE: 50,              // 개별 파일 최대 크기
        PROJECT_QUOTA: 500,             // 프로젝트당 총 용량
        USER_PERSONAL_QUOTA: 1024,      // 사용자별 개인 문서 할당량
        MAX_FILES_PER_PROJECT: 1000,    // 프로젝트당 최대 문서 수
        MAX_SIMULTANEOUS_UPLOAD: 10,    // 최대 동시 업로드 파일 수
        DAILY_UPLOAD_LIMIT: 100         // 일일 업로드 한도
    };
    
    // Warning thresholds
    const WARNING_THRESHOLDS = {
        LOW: 0.8,    // 80%
        HIGH: 0.95   // 95%
    };
    
    // Mock data for projects and chats
    let projects = [
        {
            id: 'proj1',
            name: 'H-Line 수출 프로젝트',
            documentCount: 24,
            storage: {
                used: 124.5, // MB
                total: 500   // MB
            },
            chats: [
                { id: 'chat1', title: 'HS 코드 분류 검토', lastMessage: '올해 관세율은...', time: '방금 전' },
                { id: 'chat2', title: '운송 경로 최적화', lastMessage: '부산항 경유시...', time: '2시간 전' }
            ],
            documents: {
                organization: [
                    { 
                        type: 'folder', 
                        name: '계약서', 
                        path: '/조직문서/계약서',
                        files: [
                            {
                                name: '2024_H-Line_계약서.pdf',
                                updateDate: '2024-08-15 14:30',
                                updater: '김책임 과장',
                                size: '2.5MB'
                            },
                            {
                                name: '부속합의서.docx',
                                updateDate: '2024-08-20 10:15',
                                updater: '이상무 대리',
                                size: '1.2MB'
                            }
                        ]
                    },
                    { 
                        type: 'folder', 
                        name: '관세자료',
                        path: '/조직문서/관세자료',
                        files: [
                            {
                                name: 'HS_코드_분류표.xlsx',
                                updateDate: '2024-07-01 09:00',
                                updater: '박무역 부장',
                                size: '3.8MB'
                            },
                            {
                                name: '관세율표.pdf',
                                updateDate: '2024-07-01 09:00',
                                updater: '박무역 부장',
                                size: '5.2MB'
                            }
                        ]
                    },
                    { 
                        type: 'folder', 
                        name: '법무자료',
                        path: '/조직문서/법무자료',
                        files: [
                            {
                                name: '수출입법령.pdf',
                                updateDate: '2024-06-15 16:45',
                                updater: '최법무 팀장',
                                size: '8.9MB'
                            },
                            {
                                name: 'FTA_가이드.pdf',
                                updateDate: '2024-06-20 11:30',
                                updater: '최법무 팀장',
                                size: '6.7MB'
                            }
                        ]
                    }
                ],
                personal: [
                    { 
                        type: 'file', 
                        name: '프로젝트_요약.pptx',
                        uploadDate: '2024-08-25 13:20',
                        size: '4.5MB',
                        path: '/개인문서'
                    },
                    { 
                        type: 'file', 
                        name: '미팅_노트.docx',
                        uploadDate: '2024-08-26 09:15',
                        size: '0.8MB',
                        path: '/개인문서'
                    },
                    { 
                        type: 'folder', 
                        name: '개인메모',
                        path: '/개인문서/개인메모',
                        files: [
                            {
                                name: '검토사항.txt',
                                uploadDate: '2024-08-27 14:00',
                                size: '0.1MB'
                            },
                            {
                                name: '체크리스트.xlsx',
                                uploadDate: '2024-08-27 15:30',
                                size: '0.3MB'
                            }
                        ]
                    }
                ]
            }
        },
        {
            id: 'proj2',
            name: '2024 연간 계획',
            documentCount: 15,
            storage: {
                used: 89.2,  // MB
                total: 500   // MB
            },
            chats: [
                { id: 'chat3', title: 'Q1 목표 설정', lastMessage: '1분기 매출 목표는...', time: '어제' }
            ],
            documents: {
                organization: [
                    { 
                        type: 'folder', 
                        name: '회사정책',
                        path: '/조직문서/회사정책',
                        files: [
                            {
                                name: '인사규정.pdf',
                                updateDate: '2024-01-10 10:00',
                                updater: '정인사 이사',
                                size: '1.5MB'
                            },
                            {
                                name: '복무규정.pdf',
                                updateDate: '2024-01-10 10:00',
                                updater: '정인사 이사',
                                size: '1.8MB'
                            }
                        ]
                    },
                    { 
                        type: 'file', 
                        name: '2024_사업계획서.pdf',
                        path: '/조직문서',
                        updateDate: '2024-01-05 09:00',
                        updater: '김기획 상무',
                        size: '12.3MB'
                    }
                ],
                personal: [
                    { 
                        type: 'folder', 
                        name: '분기별 계획',
                        path: '/개인문서/분기별 계획',
                        files: [
                            {
                                name: 'Q1_계획.docx',
                                uploadDate: '2024-01-15 11:00',
                                size: '2.1MB'
                            },
                            {
                                name: 'Q2_계획.docx',
                                uploadDate: '2024-04-01 10:30',
                                size: '2.3MB'
                            }
                        ]
                    },
                    { 
                        type: 'file', 
                        name: '연간_목표.xlsx',
                        path: '/개인문서',
                        uploadDate: '2024-01-02 14:00',
                        size: '0.5MB'
                    }
                ]
            }
        },
        {
            id: 'proj3',
            name: '신규 고객사 대응',
            documentCount: 8,
            storage: {
                used: 45.8,  // MB
                total: 500   // MB
            },
            chats: [],
            documents: {
                organization: [
                    { 
                        type: 'file', 
                        name: '회사소개서.pdf',
                        path: '/조직문서',
                        updateDate: '2024-03-01 10:00',
                        updater: '홍보부 팀장',
                        size: '15.2MB'
                    },
                    { 
                        type: 'file', 
                        name: '포트폴리오.pdf',
                        path: '/조직문서',
                        updateDate: '2024-05-15 14:30',
                        updater: '디자인팀',
                        size: '28.5MB'
                    }
                ],
                personal: [
                    { 
                        type: 'file', 
                        name: '제안서_초안.pptx',
                        path: '/개인문서',
                        uploadDate: '2024-08-28 16:00',
                        size: '8.7MB'
                    },
                    { 
                        type: 'file', 
                        name: '견적서.xlsx',
                        path: '/개인문서',
                        uploadDate: '2024-08-28 17:30',
                        size: '0.4MB'
                    }
                ]
            }
        }
    ];
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
        // Load saved data from localStorage
        loadDataFromLocalStorage();
        
        WeraserCore.init('phase1');
        renderSidebar();
        showWelcomeScreen();
        
        // Initialize Gemini without modal
        window.NO_API_MODAL = true;
        if (typeof initializeGeminiChat === 'function') {
            initializeGeminiChat();
        }
    });
    
    // Render storage progress
    function renderStorageProgress(project) {
        if (!project || !project.storage) return '';
        
        const { used, total } = project.storage;
        const percentage = (used / total * 100).toFixed(1);
        const isWarning = percentage > 80;
        
        return `
            <div class="storage-progress">
                <div class="storage-header">
                    <div class="storage-title">💾 저장 공간</div>
                    <div class="storage-info">${used.toFixed(1)} MB / ${total} MB (${percentage}%)</div>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill ${isWarning ? 'progress-warning' : ''}" style="width: ${percentage}%"></div>
                </div>
                <div class="storage-details">
                    <span>사용 가능: ${(total - used).toFixed(1)} MB</span>
                    ${isWarning ? '<span style="color: #ff6b6b;">⚠️ 용량 주의</span>' : ''}
                </div>
            </div>
        `;
    }
    
    // Render document tree
    function renderDocumentTree(documents, project) {
        if (!documents) return '<div class="empty-state" style="padding: 12px; font-size: 12px;">문서가 없습니다</div>';
        
        const orgCount = countDocuments(documents.organization);
        const personalCount = countDocuments(documents.personal);
        
        return `
            <div class="doc-category expanded" id="orgDocs">
                <div class="doc-category-header" onclick="toggleDocCategory('orgDocs')">
                    <span class="doc-category-icon">▼</span>
                    <span class="doc-category-label">🏢 조직 문서</span>
                    <span class="doc-category-count">${orgCount}</span>
                </div>
                <div class="doc-items">
                    ${renderDocumentItems(documents.organization, 'org')}
                </div>
            </div>
            <div class="doc-category" id="personalDocs">
                <div class="doc-category-header" onclick="toggleDocCategory('personalDocs')">
                    <span class="doc-category-icon">▶</span>
                    <span class="doc-category-label">👤 개인 문서</span>
                    <span class="doc-category-count">${personalCount}</span>
                </div>
                <div class="doc-items">
                    ${renderDocumentItems(documents.personal, 'personal')}
                </div>
            </div>
        `;
    }
    
    // Render document items with path
    function renderDocumentItems(items, type = 'org', basePath = '') {
        if (!items || items.length === 0) return '<div style="padding: 4px 8px; color: #a4a4a2; font-size: 11px;">비어 있음</div>';
        
        return items.map(item => {
            const currentPath = item.path || (basePath ? `${basePath}/${item.name}` : item.name);
            
            if (item.type === 'folder') {
                return `
                    <div class="doc-folder" id="folder-${item.name}">
                        <div class="doc-folder-header" onclick="toggleDocFolder('folder-${item.name}')" title="경로: ${currentPath}">
                            <span class="doc-category-icon">▶</span>
                            <span>📁</span>
                            <span class="doc-item-name">${item.name}</span>
                        </div>
                        <div class="doc-folder-files">
                            ${item.files.map(file => {
                                const fileName = typeof file === 'string' ? file : file.name;
                                const fileData = typeof file === 'object' ? file : null;
                                const filePath = `${currentPath}/${fileName}`;
                                const tooltip = type === 'org' && fileData 
                                    ? `경로: ${filePath}\n업데이트: ${fileData.updateDate}\n담당자: ${fileData.updater}`
                                    : type === 'personal' && fileData
                                    ? `경로: ${filePath}\n업로드: ${fileData.uploadDate}`
                                    : `경로: ${filePath}`;
                                return `
                                    <div class="doc-item" onclick="selectDocument('${filePath}', '${type}', ${fileData ? `'${JSON.stringify(fileData).replace(/'/g, "&#39;").replace(/"/g, "&quot;")}'` : 'null'})" title="${tooltip}">
                                        <span class="doc-item-icon">${getFileIcon(fileName)}</span>
                                        <span class="doc-item-name">${fileName}</span>
                                        ${type === 'org' ? '<span class="sync-status" title="자동 동기화">🔄</span>' : ''}
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            } else {
                const tooltip = type === 'org' && item.updateDate
                    ? `경로: ${currentPath}\n업데이트: ${item.updateDate}\n담당자: ${item.updater}`
                    : type === 'personal' && item.uploadDate
                    ? `경로: ${currentPath}\n업로드: ${item.uploadDate}`
                    : `경로: ${currentPath}`;
                return `
                    <div class="doc-item" onclick="selectDocument('${currentPath}', '${type}', ${item ? `'${JSON.stringify(item).replace(/'/g, "&#39;").replace(/"/g, "&quot;")}'` : 'null'})" title="${tooltip}">
                        <span class="doc-item-icon">${getFileIcon(item.name)}</span>
                        <span class="doc-item-name">${item.name}</span>
                        ${type === 'org' ? '<span class="sync-status" title="자동 동기화">🔄</span>' : ''}
                    </div>
                `;            
            }
        }).join('');
    }
    
    // Count documents
    function countDocuments(items) {
        if (!items) return 0;
        let count = 0;
        items.forEach(item => {
            if (item.type === 'folder') {
                count += item.files.length;
            } else {
                count += 1;
            }
        });
        return count;
    }
    
    // Get file icon based on extension
    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const icons = {
            'pdf': '📕',
            'docx': '📄',
            'doc': '📄',
            'xlsx': '📊',
            'xls': '📊',
            'pptx': '📊',
            'ppt': '📊',
            'txt': '📝',
            'csv': '📊'
        };
        return icons[ext] || '📄';
    }
    
    // Toggle document category
    function toggleDocCategory(categoryId) {
        const category = document.getElementById(categoryId);
        category.classList.toggle('expanded');
    }
    
    // Toggle document folder
    function toggleDocFolder(folderId) {
        const folder = document.getElementById(folderId);
        folder.classList.toggle('expanded');
        const icon = folder.querySelector('.doc-category-icon');
        icon.textContent = folder.classList.contains('expanded') ? '▼' : '▶';
    }
    
    // Render sidebar based on current view
    function renderSidebar() {
        const sidebar = document.getElementById('sidebar');
        
        if (currentView === 'projects') {
            // Show project list
            sidebar.innerHTML = `
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        <span>프로젝트</span>
                        <button class="icon-button" onclick="createNewProject()" title="새 프로젝트">+</button>
                    </div>
                    <div class="project-list" id="projectList">
                        ${projects.map(project => `
                            <div class="project-item" onclick="selectProject('${project.id}')">
                                <div class="project-item-header">
                                    <span class="project-icon">📁</span>
                                    <span class="project-name">${project.name}</span>
                                </div>
                                <div class="project-meta">
                                    <span class="doc-count">📄 ${project.documentCount}개</span>
                                    <span class="chat-count">💬 ${project.chats.length}개</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        } else if (currentView === 'chats' && currentProject) {
            // Show chat list for selected project
            const project = projects.find(p => p.id === currentProject);
            sidebar.innerHTML = `
                <div class="sidebar-header">
                    <div class="back-button" onclick="backToProjects()" title="프로젝트 목록으로">
                        <span>←</span>
                    </div>
                    <div style="flex: 1;">
                        <div style="font-size: 14px; font-weight: 600;">${project.name}</div>
                        <div style="font-size: 12px; color: #a4a4a2;">📄 ${project.documentCount}개 문서</div>
                    </div>
                </div>
                <div class="sidebar-section">
                    <div class="sidebar-title">
                        <span>채팅 세션</span>
                        <button class="icon-button" onclick="createNewChat('${project.id}')" title="새 채팅">+</button>
                    </div>
                    <div class="chat-list" id="chatList">
                        ${project.chats.length > 0 ? project.chats.map(chat => `
                            <div class="chat-item ${currentChat === chat.id ? 'active' : ''}" onclick="selectChat('${project.id}', '${chat.id}')">
                                <div class="chat-title">${chat.title}</div>
                                <div class="chat-preview">${chat.lastMessage}</div>
                                <div class="chat-time">${chat.time}</div>
                            </div>
                        `).join('') : `
                            <div class="empty-state">
                                <div style="font-size: 32px; margin-bottom: 8px;">💬</div>
                                <div style="font-size: 14px;">채팅이 없습니다</div>
                                <button class="btn btn--primary btn--small" style="margin-top: 12px;" onclick="createNewChat('${project.id}')">첫 채팅 시작</button>
                            </div>
                        `}
                    </div>
                </div>
                <div class="sidebar-section" style="border-top: 1px solid #e9e9e7;">
                    <div class="sidebar-title">
                        <span>문서 관리</span>
                        <div class="document-add-container">
                            <button class="document-add-btn" onclick="toggleDocumentAddMenu()" title="문서 추가">
                                ➕ 문서 추가
                                <span class="dropdown-arrow">▼</span>
                            </button>
                            <div class="document-add-dropdown" id="documentAddDropdown">
                                <div class="dropdown-item" onclick="showOrgDocumentBrowser()">
                                    <span>📁</span>
                                    <span>조직 문서 불러오기</span>
                                </div>
                                <div class="dropdown-item" onclick="showPersonalUpload()">
                                    <span>📤</span>
                                    <span>개인 문서 업로드</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="document-tree" id="sidebarDocumentTree">
                        ${renderDocumentTree(project.documents)}
                    </div>
                </div>
            `;
        }
    }
    
    // Navigate to project's chat list
    function selectProject(projectId) {
        currentProject = projectId;
        currentView = 'chats';
        renderSidebar();
        updateBreadcrumb();
        
        // Show project welcome or last chat
        const project = projects.find(p => p.id === projectId);
        if (project.chats.length > 0) {
            selectChat(projectId, project.chats[0].id);
        } else {
            showProjectWelcome(projectId);
        }
    }
    
    // Back to project list
    function backToProjects() {
        currentView = 'projects';
        currentProject = null;
        currentChat = null;
        renderSidebar();
        updateBreadcrumb();
        showWelcomeScreen();
    }
    
    // Update breadcrumb based on current view
    function updateBreadcrumb() {
        const breadcrumb = document.getElementById('breadcrumb');
        
        if (currentView === 'projects') {
            breadcrumb.innerHTML = '<span class="breadcrumb-current">프로젝트</span>';
        } else if (currentView === 'chats' && currentProject) {
            const project = projects.find(p => p.id === currentProject);
            const chat = currentChat ? project.chats.find(c => c.id === currentChat) : null;
            
            breadcrumb.innerHTML = `
                <span class="breadcrumb-item" onclick="backToProjects()">프로젝트</span>
                <span class="breadcrumb-separator">/</span>
                <span class="breadcrumb-item" onclick="selectProject('${project.id}')">${project.name}</span>
                ${chat ? `
                    <span class="breadcrumb-separator">/</span>
                    <span class="breadcrumb-current">${chat.title}</span>
                ` : ''}
            `;
        }
    }
    
    // Select a chat
    function selectChat(projectId, chatId) {
        currentChat = chatId;
        
        // Update active state in sidebar
        document.querySelectorAll('.chat-item').forEach(item => {
            item.classList.remove('active');
        });
        const chatElement = event.currentTarget;
        if (chatElement && chatElement.classList) {
            chatElement.classList.add('active');
        }
        
        updateBreadcrumb();
        loadChatMessages(chatId);
    }
    
    // Show welcome screen
    function showWelcomeScreen() {
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <div class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">🤖</div>
                    <h2 class="welcome-title">Weraser에 오신 것을 환영합니다</h2>
                    <p>프로젝트를 선택하여 시작하세요</p>
                </div>
            </div>
        `;
    }
    
    // Show project welcome
    function showProjectWelcome(projectId) {
        const project = projects.find(p => p.id === projectId);
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <div class="welcome-screen">
                <div class="welcome-content">
                    <div class="welcome-icon">📁</div>
                    <h2 class="welcome-title">${project.name}</h2>
                    <p style="margin-bottom: 16px;">문서 ${project.documentCount}개 준비됨</p>
                    <button class="btn btn--primary" onclick="createNewChat('${projectId}')">채팅 시작하기</button>
                </div>
            </div>
        `;
    }
    
    // Load chat messages
    function loadChatMessages(chatId) {
        const project = projects.find(p => p.id === currentProject);
        const chat = project.chats.find(c => c.id === chatId);
        
        const mainContent = document.getElementById('mainContent');
        mainContent.innerHTML = `
            <div class="chat-header">
                <div class="chat-header-info">
                    <div class="chat-header-title">${chat.title}</div>
                </div>
                <div class="chat-header-actions">
                    <button class="action-button" onclick="renameChat()">이름 변경</button>
                    <button class="action-button" onclick="deleteChat()">삭제</button>
                    <button class="action-button ${showThinkingProcess ? 'active' : ''}" onclick="toggleThinkingMode()">
                        사고 과정
                    </button>
                </div>
            </div>
            <div class="chat-messages" id="chatMessages">
                <!-- Messages will be loaded here -->
            </div>
            <div class="chat-input-wrapper">
                <div class="chat-input-container">
                    <textarea 
                        class="chat-input-field" 
                        id="chatInput" 
                        placeholder="메시지를 입력하세요..."
                        onkeydown="handleInputKeydown(event)"
                        oninput="adjustInputHeight(this)"
                    ></textarea>
                    <button class="send-button" id="sendButton" onclick="sendMessage()">
                        ➤
                    </button>
                </div>
            </div>
        `;
        
        // Load sample messages
        addSampleMessages();
    }
    
    // Add sample messages
    function addSampleMessages() {
        const messagesDiv = document.getElementById('chatMessages');
        
        // Sample 1: User asks for discount rate
        const userMessage1 = createMessage('user', '작년 H-Line 프로젝트의 최종 할인율과 근거 자료를 찾아줘');
        messagesDiv.appendChild(userMessage1);
        
        // Sample 1: AI response with references
        const aiMessage1 = createMessage('ai', 
            `작년 H-Line 프로젝트의 최종 할인율은 **15%**였습니다.
            
            근거 자료:
            1. 2023년 4분기 계약서 (p.12): "최종 합의 할인율 15% 적용"
            2. 가격 협상 회의록 (2023.10.15): "경쟁사 대비 우위 확보를 위한 전략적 할인"
            3. CFO 승인 문서: "15% 할인 승인, 단 최소 물량 보장 조건"`,
            true,
            ['2023_Q4_계약서.pdf', '가격협상_회의록.docx', 'CFO_승인문서.pdf']
        );
        messagesDiv.appendChild(aiMessage1);
        
        // Sample 2: User asks for comparison
        const userMessage2 = createMessage('user', '최근 3년간 주요 품목의 관세율 변화를 표로 정리해줘');
        messagesDiv.appendChild(userMessage2);
        
        // Sample 2: AI response with table
        const aiMessage2 = createMessage('ai', 
            `최근 3년간 주요 품목의 관세율 변화를 정리했습니다:

<table style="width: 100%; border-collapse: collapse; margin: 12px 0;">
<thead>
<tr style="background: #f7f6f3;">
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: left;">품목명</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">HS 코드</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">2022년</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">2023년</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">2024년</th>
<th style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">변화율</th>
</tr>
</thead>
<tbody>
<tr>
<td style="border: 1px solid #e9e9e7; padding: 8px;">전자부품</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">8542.31</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">8%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">4%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center; color: #22c55e;">↓ 50%</td>
</tr>
<tr style="background: #fbfbfa;">
<td style="border: 1px solid #e9e9e7; padding: 8px;">기계부품</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">8481.10</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">3%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center; color: #22c55e;">↓ 40%</td>
</tr>
<tr>
<td style="border: 1px solid #e9e9e7; padding: 8px;">화학제품</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">3901.10</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6.5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6.5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center;">6.5%</td>
<td style="border: 1px solid #e9e9e7; padding: 8px; text-align: center; color: #a4a4a2;">→ 0%</td>
</tr>
</tbody>
</table>

**주요 변화 사항:**
- FTA 체결로 인한 단계적 관세 인하 진행 중
- 전자부품과 기계부품의 관세율이 크게 감소
- 화학제품은 변동 없이 유지`,
            true,
            ['관세율표_2022.xlsx', '관세율표_2023.xlsx', '관세율표_2024.xlsx', 'FTA_영향분석.pdf']
        );
        messagesDiv.appendChild(aiMessage2);
        
        // Sample 3: User asks for trend analysis
        const userMessage3 = createMessage('user', '올해 상반기 수출 실적을 그래프로 보여주고 분석해줘');
        messagesDiv.appendChild(userMessage3);
        
        // Sample 3: AI response with chart
        const aiMessage3 = createMessage('ai', 
            `2024년 상반기 수출 실적을 분석했습니다:

<div style="background: #f7f6f3; padding: 16px; border-radius: 8px; margin: 12px 0;">
<canvas id="exportChart" style="max-width: 100%; height: 300px;"></canvas>
</div>

**📊 상반기 수출 실적 분석**

**월별 실적 (단위: 백만 달러)**
- 1월: $45.2M (전년 동기 대비 +12%)
- 2월: $42.8M (전년 동기 대비 +8%)
- 3월: $48.6M (전년 동기 대비 +15%)
- 4월: $51.3M (전년 동기 대비 +18%)
- 5월: $49.7M (전년 동기 대비 +14%)
- 6월: $53.9M (전년 동기 대비 +22%)

**핵심 인사이트:**
1. **성장 추세**: 상반기 전체 +14.8% 성장
2. **최고 실적**: 6월 $53.9M으로 역대 최고 기록
3. **주요 요인**: 
   - 신규 시장 진출 (동남아 3개국)
   - 기존 고객사 주문량 증가
   - 환율 효과 (+3% 기여)

<div style="background: #e3f2fd; padding: 12px; border-left: 4px solid #0066FF; margin: 12px 0;">
💡 **권장 사항**: 하반기에도 성장세 유지를 위해 재고 확보 및 물류 라인 점검 필요
</div>`,
            true,
            ['수출실적_2024_상반기.xlsx', '시장분석_보고서.pdf', '환율동향_분석.pdf']
        );
        messagesDiv.appendChild(aiMessage3);
        
        // Initialize chart after message is added
        setTimeout(() => {
            const canvas = document.getElementById('exportChart');
            if (canvas && canvas.getContext) {
                drawExportChart(canvas);
            }
        }, 100);
    }
    
    // Draw export chart
    function drawExportChart(canvas) {
        const ctx = canvas.getContext('2d');
        const width = canvas.width = canvas.offsetWidth;
        const height = canvas.height = 300;
        
        // Sample data
        const data = [45.2, 42.8, 48.6, 51.3, 49.7, 53.9];
        const labels = ['1월', '2월', '3월', '4월', '5월', '6월'];
        const maxValue = 60;
        
        // Clear canvas
        ctx.clearRect(0, 0, width, height);
        
        // Draw axes
        ctx.strokeStyle = '#e9e9e7';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(40, 20);
        ctx.lineTo(40, height - 40);
        ctx.lineTo(width - 20, height - 40);
        ctx.stroke();
        
        // Draw bars
        const barWidth = (width - 80) / data.length * 0.6;
        const barSpacing = (width - 80) / data.length;
        
        data.forEach((value, index) => {
            const barHeight = (value / maxValue) * (height - 80);
            const x = 40 + index * barSpacing + barSpacing * 0.2;
            const y = height - 40 - barHeight;
            
            // Bar gradient
            const gradient = ctx.createLinearGradient(0, y, 0, height - 40);
            gradient.addColorStop(0, '#0066FF');
            gradient.addColorStop(1, '#00D4AA');
            
            ctx.fillStyle = gradient;
            ctx.fillRect(x, y, barWidth, barHeight);
            
            // Value label
            ctx.fillStyle = '#37352f';
            ctx.font = '12px sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(`$${value}M`, x + barWidth / 2, y - 5);
            
            // Month label
            ctx.fillText(labels[index], x + barWidth / 2, height - 25);
        });
        
        // Y-axis labels
        ctx.fillStyle = '#787774';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'right';
        for (let i = 0; i <= 5; i++) {
            const value = (maxValue / 5) * i;
            const y = height - 40 - (i * (height - 80) / 5);
            ctx.fillText(`$${value}M`, 35, y + 4);
        }
        
        // Title
        ctx.fillStyle = '#37352f';
        ctx.font = 'bold 14px sans-serif';
        ctx.textAlign = 'left';
        ctx.fillText('2024년 상반기 월별 수출 실적', 50, 15);
    }
    
    // Create message element
    function createMessage(type, text, hasThinking = false, references = []) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message message--${type}`;
        
        const now = new Date();
        const time = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        
        if (type === 'user') {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar">나</div>
                    <div class="message-sender">사용자</div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content">
                    <div class="message-edit-wrapper">
                        <div class="message-text" contenteditable="false">${text}</div>
                        <button class="edit-button" onclick="editMessage(this)">✏️</button>
                    </div>
                </div>
            `;
        } else {
            messageDiv.innerHTML = `
                <div class="message-header">
                    <div class="message-avatar message-avatar--ai">AI</div>
                    <div class="message-sender">Weraser AI</div>
                    <div class="message-time">${time}</div>
                </div>
                <div class="message-content">
                    <div class="message-text">${text}</div>
                    ${hasThinking && showThinkingProcess ? `
                        <div class="thinking-process">
                            <div class="thinking-header" onclick="toggleThinking(this)">
                                <span>▶</span>
                                <span>사고 과정</span>
                            </div>
                            <div class="thinking-content" style="display: none;">
                                1. 질문 분석: "H-Line 프로젝트" + "할인율" 키워드 추출<br>
                                2. 문서 검색: 2023년 계약서, 회의록 검색<br>
                                3. 정보 추출: 할인율 15% 확인<br>
                                4. 교차 검증: CFO 승인 문서에서 재확인<br>
                                5. 답변 생성: 정확한 수치와 출처 명시
                            </div>
                        </div>
                    ` : ''}
                    ${references.length > 0 ? references.map(ref => `
                        <span class="reference-card" onclick="showDocument('${ref}')">
                            📄 ${ref}
                        </span>
                    `).join('') : ''}
                </div>
            `;
        }
        
        return messageDiv;
    }
    
    
    // Stop AI generation
    let generationAborted = false;
    function stopGeneration() {
        generationAborted = true;
        const typingIndicator = document.getElementById('typingIndicator');
        if (typingIndicator) {
            typingIndicator.remove();
        }
        
        // Add message that generation was stopped
        const messagesDiv = document.getElementById('chatMessages');
        const stoppedMessage = createMessage('ai', '🚫 생성이 중단되었습니다.', false, []);
        messagesDiv.appendChild(stoppedMessage);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Toggle sidebar
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('collapsed');
    }
    
    // Create new project
    function createNewProject() {
        const name = prompt('프로젝트 이름을 입력하세요:');
        if (name) {
            const newProject = {
                id: `proj${projects.length + 1}`,
                name: name,
                documentCount: 0,
                chats: [],
                documents: []
            };
            projects.push(newProject);
            renderSidebar();
            WeraserCore.ui.showNotification(`프로젝트 '${name}' 생성됨`, 'success');
        }
    }
    
    // Create new chat
    function createNewChat(projectId) {
        const chatName = prompt('채팅 이름을 입력하세요:', '새 채팅');
        if (chatName) {
            const project = projects.find(p => p.id === projectId);
            const newChat = {
                id: `chat${Date.now()}`,
                title: chatName,
                lastMessage: '',
                time: '방금 전'
            };
            project.chats.push(newChat);
            
            // Update view
            currentChat = newChat.id;
            renderSidebar();
            loadChatMessages(newChat.id);
            WeraserCore.ui.showNotification(`채팅 '${chatName}' 생성됨`, 'success');
        }
    }
    
    // Message editing
    function editMessage(button) {
        const wrapper = button.closest('.message-edit-wrapper');
        const messageText = wrapper.querySelector('.message-text');
        
        if (messageText.contentEditable === 'false') {
            // Start editing
            messageText.contentEditable = 'true';
            messageText.focus();
            button.textContent = '✓';
            
            // Fade subsequent AI messages
            let nextMessage = wrapper.closest('.message').nextElementSibling;
            while (nextMessage) {
                if (nextMessage.classList.contains('message--ai')) {
                    nextMessage.style.opacity = '0.3';
                }
                nextMessage = nextMessage.nextElementSibling;
            }
        } else {
            // Finish editing and regenerate
            messageText.contentEditable = 'false';
            button.textContent = '✏️';
            
            // Remove faded messages and regenerate AI response
            let nextMessage = wrapper.closest('.message').nextElementSibling;
            while (nextMessage && nextMessage.classList.contains('message--ai')) {
                const temp = nextMessage.nextElementSibling;
                nextMessage.remove();
                nextMessage = temp;
            }
            
            // Generate new AI response
            generateAIResponse(messageText.textContent);
        }
    }
    
    // Generate AI response
    async function generateAIResponse(message) {
        const messagesDiv = document.getElementById('chatMessages');
        
        // Use direct Gemini Chat like index-clean.html
        if (!window.geminiChat) {
            console.error('Gemini API not initialized');
            return;
        }
        
        // Show typing indicator with animation
        const typingIndicator = document.createElement('div');
        typingIndicator.className = 'typing-indicator';
        typingIndicator.innerHTML = `
            <div class="typing-dots">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
            <span style="color: #787774;">Weraser AI가 답변을 생성하고 있습니다...</span>
        `;
        messagesDiv.appendChild(typingIndicator);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        
        // Get current project documents
        const project = projects.find(p => p.id === currentProject);
        const documents = project && Array.isArray(project.documents) ? project.documents.map(doc => ({
            name: doc.name,
            type: doc.type || 'file',
            content: doc.content || '' // In real implementation, would load actual content
        })) : [];
        
        try {
            // Use direct Gemini Chat for reliable API calls
            const result = await window.geminiChat.sendMessage(message, documents);
            
            // Remove typing indicator
            typingIndicator.remove();
            
            if (result && result.success) {
                // Create AI message with actual Gemini response
                const responseText = result.response;
                
                const aiMessage = createMessage('ai', 
                    responseText,
                    true,
                    []
                );
                messagesDiv.appendChild(aiMessage);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
                
                console.log('Gemini response received successfully');
            } else {
                // Handle error
                const errorMessage = result?.error || 'API 응답 오류';
                const aiMessage = createMessage('ai', 
                    `오류: ${errorMessage}`,
                    false,
                    []
                );
                messagesDiv.appendChild(aiMessage);
                messagesDiv.scrollTop = messagesDiv.scrollHeight;
            }
        } catch (error) {
            console.error('Gemini API Error:', error);
            
            // Remove typing indicator
            if (typingIndicator && typingIndicator.parentNode) {
                typingIndicator.remove();
            }
            
            // Error message
            const aiMessage = createMessage('ai', 
                `오류가 발생했습니다: ${error.message}\n\nAPI 연결을 확인해주세요.`,
                false,
                []
            );
            messagesDiv.appendChild(aiMessage);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
    }
    
    // Toggle thinking process
    function toggleThinking(element) {
        const content = element.nextElementSibling;
        const toggle = element.querySelector('span:first-child');
        
        if (content.style.display === 'none' || !content.style.display) {
            content.style.display = 'block';
            toggle.textContent = '▼';
        } else {
            content.style.display = 'none';
            toggle.textContent = '▶';
        }
    }
    
    // Toggle thinking mode
    function toggleThinkingMode() {
        showThinkingProcess = !showThinkingProcess;
        const button = event.currentTarget;
        button.classList.toggle('active');
        WeraserCore.ui.showNotification(
            showThinkingProcess ? '사고 과정 표시 켜짐' : '사고 과정 표시 꺼짐',
            'info'
        );
    }
    
    // Send message
    async function sendMessage() {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        if (!message) return;
        
        // Add user message
        const messagesDiv = document.getElementById('chatMessages');
        const userMessage = createMessage('user', message);
        messagesDiv.appendChild(userMessage);
        
        // Clear input
        input.value = '';
        input.style.height = 'auto';
        
        // Disable send button
        document.getElementById('sendButton').disabled = true;
        
        // Generate AI response
        await generateAIResponse(message);
        
        // Enable send button
        document.getElementById('sendButton').disabled = false;
        
        // Scroll to bottom
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
    
    // Handle input keydown
    function handleInputKeydown(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault();
            sendMessage();
        }
    }
    
    // Adjust input height
    function adjustInputHeight(textarea) {
        textarea.style.height = 'auto';
        textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
    }
    
    // Upload document
    // Legacy upload function - replaced by new modal system
    function uploadDocument() {
        // Redirect to new upload system
        showPersonalUpload();
    }
    
    // Toggle document add dropdown menu
    function toggleDocumentAddMenu() {
        const dropdown = document.getElementById('documentAddDropdown');
        const button = document.querySelector('.document-add-btn');
        
        if (dropdown.classList.contains('show')) {
            dropdown.classList.remove('show');
            button.classList.remove('active');
        } else {
            dropdown.classList.add('show');
            button.classList.add('active');
        }
    }
    
    // Close dropdown when clicking outside
    document.addEventListener('click', function(event) {
        const container = document.querySelector('.document-add-container');
        if (container && !container.contains(event.target)) {
            const dropdown = document.getElementById('documentAddDropdown');
            const button = document.querySelector('.document-add-btn');
            if (dropdown && button) {
                dropdown.classList.remove('show');
                button.classList.remove('active');
            }
        }
    });
    
    // Show organization document browser modal
    function showOrgDocumentBrowser() {
        // Close dropdown first
        toggleDocumentAddMenu();
        
        // Remove any existing modals first
        const existingModals = document.querySelectorAll('.modal, .modal-overlay');
        existingModals.forEach(modal => modal.remove());
        
        // Get current usage for quota display
        const currentUsage = calculateCurrentUsage(currentProject);
        const usagePercentage = (currentUsage.size / QUOTA_LIMITS.PROJECT_QUOTA * 100).toFixed(1);
        
        // Create organization document browser modal
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.style.zIndex = '10000';
        modal.innerHTML = `
            <div class="modal-container" style="width: 85%; max-width: 900px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: none;">
                <div class="modal-header">
                    <div class="modal-header-content">
                        <div>
                            <h3>📁 조직 문서 불러오기</h3>
                            <div class="quota-navigation">
                                <div class="quota-bar">
                                    <div class="quota-fill" style="width: ${usagePercentage}%"></div>
                                </div>
                                <span class="quota-text">${currentUsage.size.toFixed(1)}MB / ${QUOTA_LIMITS.PROJECT_QUOTA}MB (${usagePercentage}%)</span>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                </div>
                <div class="modal-content" style="padding: 20px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                    <div class="browser-tips" style="padding: 12px 0; margin-bottom: 16px; font-size: 12px; color: #787774;">
                        💡 <strong>사용법:</strong> 폴더를 클릭하여 확장하고, 체크박스로 문서를 선택하세요. 
                        선택한 문서들이 프로젝트에 자동으로 동기화됩니다.
                    </div>
                    <div class="org-browser-unified" style="display: flex; flex-direction: column;">
                        
                        <!-- Step 1: Browse and Select Documents -->
                        <div class="workflow-step">
                            <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #37352f; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 24px; height: 24px; background: #007acc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">1</span>
                                조직 문서 탐색 및 선택
                            </h4>
                            
                            <div class="org-browser-tree" style="padding: 12px 0; margin-bottom: 16px;">
                                <div class="org-folder expanded" onclick="toggleOrgFolder(this)" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; background: white; transition: all 0.2s;">
                                    <span class="folder-icon" style="margin-right: 10px; font-size: 16px;">📁</span>
                                    <span class="folder-name" style="flex: 1; font-weight: 600; color: #37352f;">조직문서</span>
                                    <span class="folder-count" style="color: #787774; font-size: 11px; background: #f1f1ef; padding: 2px 6px; border-radius: 4px;">(12개 문서)</span>
                                </div>
                                <div class="org-folder-content" style="margin-left: 20px; display: block;">
                                    <div class="org-folder" onclick="toggleOrgFolder(this)" style="display: flex; align-items: center; padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                                        <span class="folder-icon" style="margin-right: 8px; font-size: 14px;">📂</span>
                                        <span class="folder-name" style="flex: 1; font-weight: 500; color: #37352f;">계약서</span>
                                        <span class="folder-count" style="color: #787774; font-size: 10px; background: #f1f1ef; padding: 1px 4px; border-radius: 3px;">(3개)</span>
                                    </div>
                                    <div class="org-folder-content" style="margin-left: 20px; display: none;">
                                        <div class="org-file" onclick="toggleFileSelection(this, event)" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; border: 1px solid transparent;">
                                            <input type="checkbox" class="file-checkbox" onchange="updateOrgSelectionInfo()" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc; cursor: pointer;">
                                            <span class="file-icon" style="margin-right: 12px; font-size: 16px;">📄</span>
                                            <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                <span class="file-name" style="font-weight: 500; color: #37352f; font-size: 14px; line-height: 1.3;">2024_H-Line_계약서.pdf</span>
                                                <span class="file-meta" style="color: #787774; font-size: 12px; line-height: 1.3;">2.5MB • 2024-08-15</span>
                                            </div>
                                        </div>
                                        <div class="org-file" onclick="toggleFileSelection(this, event)" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; border: 1px solid transparent;">
                                            <input type="checkbox" class="file-checkbox" onchange="updateOrgSelectionInfo()" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc; cursor: pointer;">
                                            <span class="file-icon" style="margin-right: 12px; font-size: 16px;">📝</span>
                                            <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                <span class="file-name" style="font-weight: 500; color: #37352f; font-size: 14px; line-height: 1.3;">부속합의서.docx</span>
                                                <span class="file-meta" style="color: #787774; font-size: 12px; line-height: 1.3;">1.2MB • 2024-08-20</span>
                                            </div>
                                        </div>
                                        <div class="org-file" onclick="toggleFileSelection(this, event)" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; border: 1px solid transparent;">
                                            <input type="checkbox" class="file-checkbox" onchange="updateOrgSelectionInfo()" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc; cursor: pointer;">
                                            <span class="file-icon" style="margin-right: 12px; font-size: 16px;">📊</span>
                                            <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                <span class="file-name" style="font-weight: 500; color: #37352f; font-size: 14px; line-height: 1.3;">계약조건_분석.xlsx</span>
                                                <span class="file-meta" style="color: #787774; font-size: 12px; line-height: 1.3;">1.8MB • 2024-08-10</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="org-folder" onclick="toggleOrgFolder(this)" style="display: flex; align-items: center; padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                                        <span class="folder-icon" style="margin-right: 8px; font-size: 14px;">📂</span>
                                        <span class="folder-name" style="flex: 1; font-weight: 500; color: #37352f;">관세자료</span>
                                        <span class="folder-count" style="color: #787774; font-size: 10px; background: #f1f1ef; padding: 1px 4px; border-radius: 3px;">(4개)</span>
                                    </div>
                                    <div class="org-folder-content" style="margin-left: 20px; display: none;">
                                        <div class="org-file" onclick="toggleFileSelection(this, event)" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; border: 1px solid transparent;">
                                            <input type="checkbox" class="file-checkbox" onchange="updateOrgSelectionInfo()" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc; cursor: pointer;">
                                            <span class="file-icon" style="margin-right: 12px; font-size: 16px;">📊</span>
                                            <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                <span class="file-name" style="font-weight: 500; color: #37352f; font-size: 14px; line-height: 1.3;">HS_코드_분류표.xlsx</span>
                                                <span class="file-meta" style="color: #787774; font-size: 12px; line-height: 1.3;">3.8MB • 2024-07-01</span>
                                            </div>
                                        </div>
                                        <div class="org-file" onclick="toggleFileSelection(this, event)" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; border: 1px solid transparent;">
                                            <input type="checkbox" class="file-checkbox" onchange="updateOrgSelectionInfo()" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc; cursor: pointer;">
                                            <span class="file-icon" style="margin-right: 12px; font-size: 16px;">📄</span>
                                            <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                <span class="file-name" style="font-weight: 500; color: #37352f; font-size: 14px; line-height: 1.3;">관세법_개정사항.pdf</span>
                                                <span class="file-meta" style="color: #787774; font-size: 12px; line-height: 1.3;">4.2MB • 2024-06-15</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="org-folder" onclick="toggleOrgFolder(this)" style="display: flex; align-items: center; padding: 6px 8px; margin-bottom: 2px; border-radius: 4px; cursor: pointer; transition: all 0.2s;">
                                        <span class="folder-icon" style="margin-right: 8px; font-size: 14px;">📂</span>
                                        <span class="folder-name" style="flex: 1; font-weight: 500; color: #37352f;">회의록</span>
                                        <span class="folder-count" style="color: #787774; font-size: 10px; background: #f1f1ef; padding: 1px 4px; border-radius: 3px;">(5개)</span>
                                    </div>
                                    <div class="org-folder-content" style="margin-left: 20px; display: none;">
                                        <div class="org-file" onclick="toggleFileSelection(this, event)" onmouseover="this.style.background='#f0f8ff'" onmouseout="this.style.background='white'" style="display: flex; align-items: center; padding: 8px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white; border: 1px solid transparent;">
                                            <input type="checkbox" class="file-checkbox" onchange="updateOrgSelectionInfo()" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc; cursor: pointer;">
                                            <span class="file-icon" style="margin-right: 12px; font-size: 16px;">📝</span>
                                            <div style="flex: 1; display: flex; flex-direction: column; gap: 2px;">
                                                <span class="file-name" style="font-weight: 500; color: #37352f; font-size: 14px; line-height: 1.3;">2024년_3분기_검토회의.docx</span>
                                                <span class="file-meta" style="color: #787774; font-size: 12px; line-height: 1.3;">0.8MB • 2024-07-25</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Step 2: Import Selection Summary -->
                        <div class="workflow-step">
                            <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #37352f; display: flex; align-items: center; gap: 8px;">
                                <span style="width: 24px; height: 24px; background: #007acc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">2</span>
                                불러오기 확인 및 실행
                            </h4>
                            
                            <div class="selection-summary-unified" style="padding: 16px; border-radius: 8px;">
                                <div class="summary-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                    <h5 style="margin: 0; font-size: 14px; font-weight: 600; color: #37352f;">📋 선택 요약</h5>
                                    <div class="selection-counts" style="font-size: 12px; color: #787774;">
                                        <span id="selectedCount">선택된 문서: 0개</span>
                                        <span style="margin-left: 12px;" id="totalSize">총 크기: 0MB</span>
                                    </div>
                                </div>
                                
                                <div class="import-controls" style="display: flex; align-items: center; justify-content: space-between;">
                                    <div class="quota-status" style="font-size: 11px; color: #787774;">
                                        <span id="orgQuotaHelp">💡 프로젝트 용량 한도: 500MB</span>
                                        <span id="orgQuotaWarning" class="quota-warning" style="display: none; margin-left: 8px; color: #ef4444;"></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid #e9e9e7; display: flex; justify-content: space-between;">
                    <button class="btn-secondary" onclick="closeModal()">취소</button>
                    <button class="btn-primary" id="importBtn" onclick="importSelectedDocuments()" disabled>
                        📥 불러오기
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Initialize the organization browser
        setTimeout(() => {
            // Auto-expand the main organization folder to show content
            const mainFolder = modal.querySelector('.org-folder.expanded');
            if (mainFolder) {
                const icon = mainFolder.querySelector('.folder-icon');
                if (icon) icon.textContent = '📂';
            }
            
            // Auto-expand contract folder as an example
            const contractFolder = modal.querySelector('.org-folder[onclick*="toggleOrgFolder"]');
            if (contractFolder && contractFolder.querySelector('.folder-name').textContent === '계약서') {
                toggleOrgFolder(contractFolder);
            }
            
            updateOrgSelectionInfo();
        }, 10);
    }
    
    // Show personal document upload with directory selection
    function showPersonalUpload() {
        // Close dropdown first
        toggleDocumentAddMenu();
        
        // Remove any existing modals first
        const existingModals = document.querySelectorAll('.modal, .modal-overlay');
        existingModals.forEach(modal => modal.remove());
        
        // Get current usage for quota display
        const currentUsage = calculateCurrentUsage(currentProject);
        const usagePercentage = (currentUsage.size / QUOTA_LIMITS.PROJECT_QUOTA * 100).toFixed(1);
        const remainingQuota = QUOTA_LIMITS.PROJECT_QUOTA - currentUsage.size;
        
        // Create personal upload modal
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-container" style="width: 70%; max-width: 800px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: none;">
                <div class="modal-header">
                    <div class="modal-header-content">
                        <div>
                            <h3>개인 문서 업로드</h3>
                            <div class="quota-navigation">
                                <div class="quota-bar">
                                    <div class="quota-fill" style="width: ${usagePercentage}%"></div>
                                </div>
                                <span class="quota-text">${currentUsage.size.toFixed(1)}MB / ${QUOTA_LIMITS.PROJECT_QUOTA}MB (${usagePercentage}%)</span>
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                </div>
                <div class="modal-content" style="padding: 24px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                    <div class="upload-tips" style="padding: 12px 0; margin-bottom: 20px; flex-shrink: 0;">
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">💡</span>
                            <span style="font-size: 13px; color: #37352f;">개인 문서는 내 계정에만 저장되며 프로젝트 용량에 포함됩니다</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px;">
                            <span style="font-size: 18px;">📂</span>
                            <span style="font-size: 13px; color: #37352f;">디렉토리 구조를 활용해 체계적으로 관리하세요</span>
                        </div>
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 18px;">⚡</span>
                            <span style="font-size: 13px; color: #37352f;">남은 용량: <strong>${remainingQuota.toFixed(1)}MB</strong></span>
                        </div>
                    </div>
                    
                    <div class="upload-workflow-unified" style="display: flex; flex-direction: column;">
                    
                    <!-- Step 1: Directory Selection -->
                    <div class="workflow-step" style="margin-bottom: 24px;">
                        <h4 style="margin: 0 0 16px 0; font-size: 16px; color: #37352f; display: flex; align-items: center; gap: 8px;">
                            <span style="width: 24px; height: 24px; background: #007acc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">1</span>
                            저장 위치 선택
                        </h4>
                        
                        <!-- Existing Directories -->
                        <div style="margin-bottom: 20px;">
                            <h5 style="margin: 0 0 10px 32px; font-size: 13px; color: #787774; font-weight: 500;">기존 디렉토리</h5>
                            <div style="display: flex; flex-direction: column; gap: 6px; margin-left: 32px;">
                                <label onclick="selectPersonalDirectory('/개인문서', this)" 
                                       onmouseover="if(!this.querySelector('input').checked) this.style.background='#f8f9fa'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.background='white'"
                                       style="display: flex; align-items: center; padding: 10px 14px; border: 1px solid #e9e9e7; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white;">
                                    <input type="radio" name="personalDirectory" value="/개인문서" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc;">
                                    <span style="margin-right: 10px; font-size: 18px;">📁</span>
                                    <span style="flex: 1; font-weight: 500; color: #37352f; font-size: 14px;">/개인문서</span>
                                    <span style="color: #787774; font-size: 12px; background: #f1f1ef; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">(5개)</span>
                                    <button onclick="event.stopPropagation(); editPersonalDirectory('/개인문서')" style="padding: 4px 8px; margin-right: 4px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">수정</button>
                                    <button onclick="event.stopPropagation(); deletePersonalDirectory('/개인문서')" style="padding: 4px 8px; font-size: 11px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">삭제</button>
                                </label>
                                <label onclick="selectPersonalDirectory('/개인문서/임시', this)"
                                       onmouseover="if(!this.querySelector('input').checked) this.style.background='#f8f9fa'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.background='white'"
                                       style="display: flex; align-items: center; padding: 10px 14px; border: 1px solid #e9e9e7; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white;">
                                    <input type="radio" name="personalDirectory" value="/개인문서/임시" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc;">
                                    <span style="margin-right: 10px; font-size: 18px;">📁</span>
                                    <span style="flex: 1; font-weight: 500; color: #37352f; font-size: 14px;">/개인문서/임시</span>
                                    <span style="color: #787774; font-size: 12px; background: #f1f1ef; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">(2개)</span>
                                    <button onclick="event.stopPropagation(); editPersonalDirectory('/개인문서/임시')" style="padding: 4px 8px; margin-right: 4px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">수정</button>
                                    <button onclick="event.stopPropagation(); deletePersonalDirectory('/개인문서/임시')" style="padding: 4px 8px; font-size: 11px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">삭제</button>
                                </label>
                                <label onclick="selectPersonalDirectory('/개인문서/계획서', this)"
                                       onmouseover="if(!this.querySelector('input').checked) this.style.background='#f8f9fa'" 
                                       onmouseout="if(!this.querySelector('input').checked) this.style.background='white'"
                                       style="display: flex; align-items: center; padding: 10px 14px; border: 1px solid #e9e9e7; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: white;">
                                    <input type="radio" name="personalDirectory" value="/개인문서/계획서" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc;">
                                    <span style="margin-right: 10px; font-size: 18px;">📁</span>
                                    <span style="flex: 1; font-weight: 500; color: #37352f; font-size: 14px;">/개인문서/계획서</span>
                                    <span style="color: #787774; font-size: 12px; background: #f1f1ef; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">(2개)</span>
                                    <button onclick="event.stopPropagation(); editPersonalDirectory('/개인문서/계획서')" style="padding: 4px 8px; margin-right: 4px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">수정</button>
                                    <button onclick="event.stopPropagation(); deletePersonalDirectory('/개인문서/계획서')" style="padding: 4px 8px; font-size: 11px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">삭제</button>
                                </label>
                            </div>
                        </div>
                        
                        <!-- New Directory -->
                        <div>
                            <h5 style="margin: 0 0 10px 32px; font-size: 13px; color: #787774; font-weight: 500;">새 디렉토리 생성</h5>
                            <div style="display: flex; gap: 8px; margin-left: 32px;">
                                <input type="text" id="newPersonalDirName" placeholder="새 디렉토리 이름 입력" 
                                       style="flex: 1; padding: 9px 12px; border: 1px solid #e9e9e7; border-radius: 6px; font-size: 14px;">
                                <button class="btn-secondary" onclick="createNewPersonalDirectory()" 
                                        style="padding: 9px 18px; font-size: 13px; white-space: nowrap; background: white; border: 1px solid #e9e9e7; border-radius: 6px; cursor: pointer; transition: all 0.2s;"
                                        onmouseover="this.style.background='#f8f9fa'" onmouseout="this.style.background='white'">
                                    생성 후 선택
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Step 2: File Upload -->
                    <div class="workflow-step">
                        <h4 style="margin: 0 0 12px 0; font-size: 16px; color: #37352f; display: flex; align-items: center; gap: 8px;">
                            <span style="width: 24px; height: 24px; background: #007acc; color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; font-weight: bold;">2</span>
                            파일 선택 및 업로드
                        </h4>
                        
                        <div class="file-upload-area" onclick="triggerPersonalFileSelect()" 
                             ondrop="handlePersonalFileDrop(event)" ondragover="handleDragOver(event)"
                             style="border: 2px dashed #e9e9e7; border-radius: 8px; padding: 32px; text-align: center; cursor: pointer; margin-bottom: 16px; transition: all 0.2s;">
                            <div class="upload-icon" style="font-size: 48px; margin-bottom: 12px;">📤</div>
                            <div class="upload-text" style="font-size: 16px; font-weight: 500; margin-bottom: 4px;">파일을 드래그하여 놓거나 클릭하여 선택하세요</div>
                            <div class="upload-formats" style="font-size: 12px; color: #787774;">지원 형식: PDF, Word, Excel, PPT, 이미지, 텍스트</div>
                        </div>
                        <input type="file" id="personalFileInput" multiple 
                               accept=".pdf,.docx,.xlsx,.csv,.txt,.pptx,.png,.jpg,.jpeg" 
                               style="display: none;" onchange="handlePersonalFileSelect(event)">
                        
                        <div class="selected-files" id="personalSelectedFiles" style="display: none; margin-bottom: 16px;">
                            <h5 style="margin: 0 0 8px 0;">선택된 파일</h5>
                            <div class="file-list" id="personalFileList" style="max-height: 120px; overflow-y: auto; border: 1px solid #e9e9e7; border-radius: 6px; background: #fafafa;">
                                <!-- Files will be listed here -->
                            </div>
                        </div>
                        
                        <!-- Upload Summary -->
                        <div class="upload-summary-unified" style="padding: 16px; border-radius: 8px;">
                            <div class="summary-header" style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px;">
                                <h5 style="margin: 0; font-size: 14px; font-weight: 600; color: #37352f;">📊 업로드 요약</h5>
                                <div class="file-counts" style="font-size: 12px; color: #787774;">
                                    <span id="personalFileCount">선택된 파일: 0개</span>
                                    <span style="margin-left: 12px;" id="personalTotalSize">총 크기: 0MB</span>
                                </div>
                            </div>
                            
                            <div class="upload-controls" style="display: flex; align-items: center; justify-content: space-between;">
                                <div class="quota-status" style="font-size: 11px; color: #787774;">
                                    <span id="personalQuotaCheck">용량 확인 중...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid #e9e9e7; display: flex; justify-content: space-between;">
                    <button class="btn-secondary" onclick="closeModal()">취소</button>
                    <button class="btn-primary" id="personalUploadBtn" onclick="executePersonalUpload()" disabled>
                        📤 업로드
                    </button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        updatePersonalSelectionInfo();
    }
    
    // Quota and validation functions
    function calculateCurrentUsage(projectId) {
        const project = projects.find(p => p.id === projectId);
        if (!project) return { size: 0, count: 0 };
        
        let totalSize = 0;
        let totalCount = 0;
        
        // Calculate organization documents
        if (project.documents.organization) {
            project.documents.organization.forEach(item => {
                if (item.type === 'file') {
                    totalSize += parseFloat(item.size?.replace('MB', '') || 0);
                    totalCount++;
                } else if (item.files) {
                    item.files.forEach(file => {
                        totalSize += parseFloat(file.size?.replace('MB', '') || 0);
                        totalCount++;
                    });
                }
            });
        }
        
        // Calculate personal documents
        if (project.documents.personal) {
            project.documents.personal.forEach(item => {
                if (item.type === 'file') {
                    totalSize += parseFloat(item.size?.replace('MB', '') || 0);
                    totalCount++;
                } else if (item.files) {
                    item.files.forEach(file => {
                        totalSize += parseFloat(file.size?.replace('MB', '') || 0);
                        totalCount++;
                    });
                }
            });
        }
        
        return { size: totalSize, count: totalCount };
    }
    
    function validateFileUpload(files, projectId) {
        const errors = [];
        const warnings = [];
        
        // Check file count limit
        if (files.length > QUOTA_LIMITS.MAX_SIMULTANEOUS_UPLOAD) {
            errors.push(`최대 ${QUOTA_LIMITS.MAX_SIMULTANEOUS_UPLOAD}개 파일만 동시에 업로드할 수 있습니다. (현재: ${files.length}개)`);
        }
        
        // Check individual file sizes and formats
        let totalNewSize = 0;
        const allowedFormats = ['.pdf', '.docx', '.xlsx', '.csv', '.txt', '.pptx', '.png', '.jpg', '.jpeg'];
        
        Array.from(files).forEach((file, index) => {
            const fileSizeMB = file.size / (1024 * 1024);
            const fileExt = '.' + file.name.split('.').pop().toLowerCase();
            
            // File size check
            if (fileSizeMB > QUOTA_LIMITS.MAX_FILE_SIZE) {
                errors.push(`파일 "${file.name}"의 크기가 ${QUOTA_LIMITS.MAX_FILE_SIZE}MB를 초과합니다. (${fileSizeMB.toFixed(1)}MB)`);
            }
            
            // Format check
            if (!allowedFormats.includes(fileExt)) {
                errors.push(`파일 "${file.name}"은(는) 지원하지 않는 형식입니다. 지원 형식: ${allowedFormats.join(', ')}`);
            }
            
            totalNewSize += fileSizeMB;
        });
        
        // Check project quota
        const currentUsage = calculateCurrentUsage(projectId);
        const newTotalSize = currentUsage.size + totalNewSize;
        const quotaUsage = newTotalSize / QUOTA_LIMITS.PROJECT_QUOTA;
        
        if (newTotalSize > QUOTA_LIMITS.PROJECT_QUOTA) {
            errors.push(`프로젝트 용량 한도를 초과합니다. (현재: ${currentUsage.size.toFixed(1)}MB, 추가: ${totalNewSize.toFixed(1)}MB, 한도: ${QUOTA_LIMITS.PROJECT_QUOTA}MB)`);
        } else if (quotaUsage >= WARNING_THRESHOLDS.HIGH) {
            warnings.push(`프로젝트 용량의 ${(quotaUsage * 100).toFixed(0)}%를 사용하게 됩니다. 용량 정리를 권장합니다.`);
        } else if (quotaUsage >= WARNING_THRESHOLDS.LOW) {
            warnings.push(`프로젝트 용량의 ${(quotaUsage * 100).toFixed(0)}%를 사용하게 됩니다.`);
        }
        
        // Check file count
        const newTotalCount = currentUsage.count + files.length;
        if (newTotalCount > QUOTA_LIMITS.MAX_FILES_PER_PROJECT) {
            errors.push(`프로젝트당 최대 ${QUOTA_LIMITS.MAX_FILES_PER_PROJECT}개 문서만 저장할 수 있습니다. (현재: ${currentUsage.count}개, 추가: ${files.length}개)`);
        }
        
        return { 
            valid: errors.length === 0, 
            errors, 
            warnings, 
            newSize: totalNewSize,
            totalSize: newTotalSize,
            quotaUsage: quotaUsage
        };
    }
    
    function updateCapacityDisplay(projectId) {
        const usage = calculateCurrentUsage(projectId);
        const percentage = (usage.size / QUOTA_LIMITS.PROJECT_QUOTA) * 100;
        
        // Update sidebar capacity bar
        const capacityFill = document.querySelector('.capacity-used');
        const capacityText = document.querySelector('.capacity-text');
        
        if (capacityFill && capacityText) {
            capacityFill.style.width = Math.min(percentage, 100) + '%';
            capacityText.textContent = `${usage.size.toFixed(1)}MB / ${QUOTA_LIMITS.PROJECT_QUOTA}MB`;
            
            // Update color based on usage
            capacityFill.className = 'capacity-used';
            if (percentage >= WARNING_THRESHOLDS.HIGH * 100) {
                capacityFill.classList.add('danger');
            } else if (percentage >= WARNING_THRESHOLDS.LOW * 100) {
                capacityFill.classList.add('warning');
            }
        }
    }
    
    // Personal Document Upload Functions
    let selectedPersonalDirectory = null;
    let personalSelectedFiles = [];

    function selectPersonalDirectory(dirPath, element) {
        selectedPersonalDirectory = dirPath;
        
        // Update radio selection
        if (element && element.querySelector) {
            const radio = element.querySelector('input[type="radio"]');
            if (radio) {
                radio.checked = true;
            }
        }
        
        // Update all directory label styling
        const dirLabels = document.querySelectorAll('label[onclick*="selectPersonalDirectory"]');
        dirLabels.forEach(label => {
            label.style.borderColor = '#e9e9e7';
            label.style.background = 'white';
            label.style.borderWidth = '1px';
        });
        
        // Highlight selected option
        if (element && element.tagName === 'LABEL') {
            element.style.borderColor = '#007acc';
            element.style.background = '#f0f8ff';
            element.style.borderWidth = '2px';
        }
        
        // Update selection info
        updatePersonalSelectionInfo();
    }

    function createNewPersonalDirectory() {
        const nameInput = document.getElementById('newPersonalDirName');
        const dirName = nameInput.value.trim();
        
        if (!dirName) {
            alert('디렉토리 이름을 입력하세요.');
            return;
        }
        
        // Validate directory name
        if (!/^[a-zA-Z0-9가-힣_\-\s]+$/.test(dirName)) {
            alert('디렉토리 이름에는 한글, 영문, 숫자, 언더스코어, 하이픈, 공백만 사용할 수 있습니다.');
            return;
        }
        
        const newDirPath = `/개인문서/${dirName}`;
        
        // Add to existing directory list
        const dirListContainer = document.querySelector('div[style*="flex-direction: column; gap: 6px; margin-left: 32px"]');
        if (dirListContainer) {
            const newDirOption = document.createElement('label');
            newDirOption.style.cssText = 'display: flex; align-items: center; padding: 10px 14px; border: 2px solid #007acc; border-radius: 6px; cursor: pointer; transition: all 0.2s; background: #f0f8ff;';
            
            const radioId = `dir-new-${Date.now()}`;
            newDirOption.innerHTML = `
                <input type="radio" name="personalDirectory" value="${newDirPath}" id="${radioId}" style="margin-right: 12px; width: 16px; height: 16px; accent-color: #007acc;" checked>
                <span style="margin-right: 10px; font-size: 18px;">📁</span>
                <span style="flex: 1; font-weight: 500; color: #37352f; font-size: 14px;">${newDirPath}</span>
                <span style="color: #787774; font-size: 12px; background: #f1f1ef; padding: 2px 8px; border-radius: 4px; margin-right: 8px;">(신규)</span>
                <button onclick="event.stopPropagation(); editPersonalDirectory('${newDirPath}')" style="padding: 4px 8px; margin-right: 4px; font-size: 11px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer;">수정</button>
                <button onclick="event.stopPropagation(); deletePersonalDirectory('${newDirPath}')" style="padding: 4px 8px; font-size: 11px; background: #dc3545; color: white; border: none; border-radius: 3px; cursor: pointer;">삭제</button>
            `;
            
            // Add event handlers
            newDirOption.onclick = () => selectPersonalDirectory(newDirPath, newDirOption);
            newDirOption.onmouseover = function() { 
                if(!this.querySelector('input').checked) this.style.background='#f8f9fa'; 
            };
            newDirOption.onmouseout = function() { 
                if(!this.querySelector('input').checked) this.style.background='white'; 
            };
            
            dirListContainer.appendChild(newDirOption);
        }
        
        // Auto-select the new directory
        selectedPersonalDirectory = newDirPath;
        
        // Clear input
        nameInput.value = '';
        
        // Update selection info
        updatePersonalSelectionInfo();
        
        // Clear input
        nameInput.value = '';
    }

    function triggerPersonalFileSelect() {
        document.getElementById('personalFileInput').click();
    }

    function handlePersonalFileSelect(event) {
        const files = Array.from(event.target.files);
        addPersonalFiles(files);
    }

    function handlePersonalFileDrop(event) {
        event.preventDefault();
        const files = Array.from(event.dataTransfer.files);
        addPersonalFiles(files);
    }

    function addPersonalFiles(files) {
        // Validate files
        const validation = validateFileUpload(files, currentProject);
        
        if (!validation.valid) {
            alert('파일 업로드 오류:\n' + validation.errors.join('\n'));
            return;
        }
        
        // Show warnings if any
        if (validation.warnings.length > 0) {
            if (!confirm('경고사항:\n' + validation.warnings.join('\n') + '\n\n계속하시겠습니까?')) {
                return;
            }
        }
        
        // Add files to selection
        files.forEach(file => {
            if (!personalSelectedFiles.find(f => f.name === file.name && f.size === file.size)) {
                personalSelectedFiles.push(file);
            }
        });
        
        // Update UI
        updatePersonalFileList();
        updatePersonalSelectionInfo();
    }

    function updatePersonalFileList() {
        const selectedFilesDiv = document.getElementById('personalSelectedFiles');
        const fileList = document.getElementById('personalFileList');
        
        if (personalSelectedFiles.length > 0) {
            selectedFilesDiv.style.display = 'block';
            fileList.innerHTML = personalSelectedFiles.map((file, index) => `
                <div class="file-item">
                    <div class="file-info">
                        <span class="file-icon">${getFileIcon(file.name)}</span>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${(file.size / (1024 * 1024)).toFixed(1)}MB</span>
                    </div>
                    <button onclick="removePersonalFile(${index})" style="background: none; border: none; color: #ef4444; cursor: pointer;">✕</button>
                </div>
            `).join('');
        } else {
            selectedFilesDiv.style.display = 'none';
        }
    }

    function removePersonalFile(index) {
        personalSelectedFiles.splice(index, 1);
        updatePersonalFileList();
        updatePersonalSelectionInfo();
    }

    function updatePersonalSelectionInfo() {
        const fileCount = document.getElementById('personalFileCount');
        const totalSize = document.getElementById('personalTotalSize');
        const quotaCheck = document.getElementById('personalQuotaCheck');
        const uploadBtn = document.getElementById('personalUploadBtn');
        
        // Update file count
        fileCount.textContent = `선택된 파일: ${personalSelectedFiles.length}개`;
        
        // Update total size
        const totalSizeMB = personalSelectedFiles.reduce((sum, file) => sum + (file.size / (1024 * 1024)), 0);
        totalSize.textContent = `총 크기: ${totalSizeMB.toFixed(1)}MB`;
        
        // Update quota check
        const currentUsage = calculateCurrentUsage(currentProject);
        const newTotalSize = currentUsage.size + totalSizeMB;
        const quotaUsage = newTotalSize / QUOTA_LIMITS.PROJECT_QUOTA;
        
        let quotaStatus = 'success';
        let quotaMessage = `사용 예정: ${newTotalSize.toFixed(1)}MB / ${QUOTA_LIMITS.PROJECT_QUOTA}MB`;
        
        if (quotaUsage >= 1.0) {
            quotaStatus = 'error';
            quotaMessage = '용량 한도 초과';
        } else if (quotaUsage >= WARNING_THRESHOLDS.HIGH) {
            quotaStatus = 'error';
            quotaMessage = '용량 한도 근접 (95%+)';
        } else if (quotaUsage >= WARNING_THRESHOLDS.LOW) {
            quotaStatus = 'warning';
            quotaMessage = '용량 주의 (80%+)';
        }
        
        quotaCheck.textContent = quotaMessage;
        quotaCheck.className = `quota-status ${quotaStatus}`;
        
        // Update upload button
        const canUpload = personalSelectedFiles.length > 0 && 
                         selectedPersonalDirectory && 
                         quotaUsage < 1.0;
        uploadBtn.disabled = !canUpload;
    }

    function executePersonalUpload() {
        if (!selectedPersonalDirectory) {
            alert('디렉토리를 선택해주세요.');
            return;
        }
        
        if (personalSelectedFiles.length === 0) {
            alert('업로드할 파일을 선택해주세요.');
            return;
        }
        
        // Show upload progress
        const uploadBtn = document.getElementById('personalUploadBtn');
        const originalText = uploadBtn.textContent;
        uploadBtn.textContent = '업로드 중...';
        uploadBtn.disabled = true;
        
        // Simulate upload process with vector indexing
        setTimeout(async () => {
            // Add files to project documents
            const project = projects.find(p => p.id === currentProject);
            if (!project.documents.personal) {
                project.documents.personal = [];
            }
            
            // Find or create directory
            let directory = project.documents.personal.find(d => d.name === selectedPersonalDirectory && d.type === 'directory');
            if (!directory) {
                directory = {
                    name: selectedPersonalDirectory,
                    type: 'directory',
                    files: []
                };
                project.documents.personal.push(directory);
            }
            
            // Process each file for vector indexing
            const uploadBtn = document.getElementById('personalUploadBtn');
            let processedCount = 0;
            
            for (const file of personalSelectedFiles) {
                // Update progress
                uploadBtn.textContent = `처리 중... (${processedCount + 1}/${personalSelectedFiles.length})`;
                
                // Add file to directory
                directory.files.push({
                    name: file.name,
                    type: 'file',
                    size: `${(file.size / (1024 * 1024)).toFixed(1)}MB`,
                    uploadDate: new Date().toISOString().split('T')[0],
                    path: `${selectedPersonalDirectory}/${file.name}`
                });
                
                // Vector indexing for personal documents
                try {
                    if (window.WeraserCore && window.WeraserCore.ragEngine) {
                        console.log(`🔍 개인문서 벡터 인덱싱 시작: ${file.name}`);
                        const indexResult = await window.WeraserCore.ragEngine.processDocument(file);
                        if (indexResult.success) {
                            console.log(`✅ 개인문서 인덱싱 완료: ${file.name} (${indexResult.chunks}개 청크)`);
                        } else {
                            console.warn(`⚠️ 개인문서 인덱싱 실패: ${file.name}`, indexResult.error);
                        }
                    }
                } catch (error) {
                    console.warn(`❌ 벡터 인덱싱 중 오류 (${file.name}):`, error);
                }
                
                processedCount++;
            }
            
            // Update project storage
            const totalNewSize = personalSelectedFiles.reduce((sum, file) => sum + (file.size / (1024 * 1024)), 0);
            project.storage.used += totalNewSize;
            
            // Reset form
            personalSelectedFiles = [];
            selectedPersonalDirectory = null;
            
            // Update UI
            updateCapacityDisplay(currentProject);
            renderSidebar();
            
            // Close modal
            closeModal();
            
            // Show success message
            alert(`${personalSelectedFiles.length}개 파일이 성공적으로 업로드되었습니다.`);
        }, 1500);
    }

    function getFileIcon(filename) {
        const ext = filename.split('.').pop().toLowerCase();
        const iconMap = {
            'pdf': '📄',
            'docx': '📝',
            'xlsx': '📊', 
            'csv': '📊',
            'pptx': '📋',
            'txt': '📝',
            'png': '🖼️',
            'jpg': '🖼️',
            'jpeg': '🖼️'
        };
        return iconMap[ext] || '📄';
    }
    
    // Personal directory management functions
    function editPersonalDirectory(dirPath) {
        const newName = prompt(`디렉토리 이름 변경:\n현재: ${dirPath}`, dirPath.split('/').pop());
        
        if (newName && newName.trim()) {
            // Validate new name
            if (!/^[a-zA-Z0-9가-힣_\-\s]+$/.test(newName)) {
                alert('디렉토리 이름에는 한글, 영문, 숫자, 언더스코어, 하이픈, 공백만 사용할 수 있습니다.');
                return;
            }
            
            const pathParts = dirPath.split('/');
            pathParts[pathParts.length - 1] = newName.trim();
            const newPath = pathParts.join('/');
            
            // Update in project documents
            const project = projects.find(p => p.id === currentProject);
            if (project && project.documents.personal) {
                const dir = project.documents.personal.find(d => d.name === dirPath.split('/').pop());
                if (dir) {
                    dir.name = newName.trim();
                    
                    // Update files paths
                    if (dir.files) {
                        dir.files.forEach(file => {
                            if (file.path) {
                                file.path = file.path.replace(dirPath, newPath);
                            }
                        });
                    }
                }
            }
            
            // Update UI
            const label = event.target.closest('label');
            if (label) {
                const pathSpan = label.querySelector('span[style*="flex: 1"]');
                if (pathSpan) {
                    pathSpan.textContent = newPath;
                }
                const radio = label.querySelector('input[type="radio"]');
                if (radio) {
                    radio.value = newPath;
                }
            }
            
            alert(`디렉토리가 '${newPath}'로 변경되었습니다.`);
            renderSidebar();
        }
    }
    
    function deletePersonalDirectory(dirPath) {
        // Check if directory has files
        const project = projects.find(p => p.id === currentProject);
        let hasFiles = false;
        
        if (project && project.documents.personal) {
            const dir = project.documents.personal.find(d => 
                d.name === dirPath.split('/').pop() || 
                (d.type === 'directory' && d.name === dirPath.split('/').pop())
            );
            if (dir && dir.files && dir.files.length > 0) {
                hasFiles = true;
            }
        }
        
        const confirmMsg = hasFiles ? 
            `'${dirPath}' 디렉토리에 파일이 있습니다.\n휴지통으로 이동하시겠습니까? (30일 후 자동 삭제)` :
            `'${dirPath}' 디렉토리를 휴지통으로 이동하시겠습니까? (30일 후 자동 삭제)`;
        
        if (confirm(confirmMsg)) {
            // Move to trash instead of permanent deletion
            if (project && project.documents.personal) {
                const dirName = dirPath.split('/').pop();
                const dirIndex = project.documents.personal.findIndex(d => 
                    d.name === dirName || 
                    (d.type === 'directory' && d.name === dirName)
                );
                
                if (dirIndex !== -1) {
                    const dir = project.documents.personal[dirIndex];
                    
                    // Create trash item
                    const trashItem = {
                        id: 'trash-' + Date.now(),
                        type: 'personal-directory',
                        name: dir.name,
                        path: dirPath,
                        fileCount: dir.files ? dir.files.length : 0,
                        deletedAt: new Date().toISOString(),
                        projectId: currentProject,
                        originalData: dir
                    };
                    
                    // Get or create trash items array
                    let trashItems = JSON.parse(localStorage.getItem('weraser_trash') || '[]');
                    trashItems.push(trashItem);
                    localStorage.setItem('weraser_trash', JSON.stringify(trashItems));
                    
                    // Remove directory from active documents
                    project.documents.personal.splice(dirIndex, 1);
                    
                    // Note: Storage space is not actually freed until permanently deleted from trash
                }
            }
            
            // Remove from UI
            const label = event.target.closest('label');
            if (label) {
                label.remove();
            }
            
            alert(`'${dirPath}' 디렉토리가 휴지통으로 이동되었습니다.\n30일 후 자동으로 삭제됩니다.`);
            
            // Update displays
            updateCapacityDisplay(currentProject);
            renderSidebar();
        }
    }

    // Organization document functions

    function toggleFileSelection(element, event) {
        if (event) event.stopPropagation();
        const checkbox = element.querySelector('input[type="checkbox"]');
        checkbox.checked = !checkbox.checked;
        updateOrgSelectionInfo();
    }

    // Modal helper functions
    function closeModal() {
        const modal = document.querySelector('.modal, .modal-overlay');
        if (modal) {
            modal.remove();
        }
        
        // Reset personal upload state
        personalSelectedFiles = [];
        selectedPersonalDirectory = null;
    }
    
    // Organization document browser functions
    function toggleOrgFolder(element) {
        const content = element.nextElementSibling;
        if (content && content.classList.contains('org-folder-content')) {
            const isExpanded = content.style.display !== 'none' && content.style.display !== '';
            content.style.display = isExpanded ? 'none' : 'block';
            
            const icon = element.querySelector('.folder-icon');
            if (icon) {
                icon.textContent = isExpanded ? '📂' : '📁';
            }
        }
    }
    
    function updateOrgSelectionInfo() {
        const checkboxes = document.querySelectorAll('.file-checkbox:checked');
        const count = checkboxes.length;
        let totalSize = 0;
        
        checkboxes.forEach(checkbox => {
            const fileElement = checkbox.closest('.org-file');
            const metaText = fileElement.querySelector('.file-meta').textContent;
            const sizeMatch = metaText.match(/([\d.]+)MB/);
            if (sizeMatch) {
                totalSize += parseFloat(sizeMatch[1]);
            }
        });
        
        const countElement = document.getElementById('selectedCount');
        const sizeElement = document.getElementById('totalSize');
        const warningElement = document.getElementById('orgQuotaWarning');
        const importBtn = document.getElementById('importBtn');
        
        if (countElement) countElement.textContent = `선택된 문서: ${count}개`;
        if (sizeElement) sizeElement.textContent = `총 크기: ${totalSize.toFixed(1)}MB`;
        
        // Check quota and update warning
        const currentUsage = calculateCurrentUsage(currentProject);
        const newTotalSize = currentUsage.size + totalSize;
        const quotaUsage = newTotalSize / QUOTA_LIMITS.PROJECT_QUOTA;
        
        if (warningElement) {
            if (quotaUsage >= WARNING_THRESHOLDS.HIGH) {
                warningElement.textContent = `용량 한도 ${(quotaUsage * 100).toFixed(0)}% 사용 - 정리 필요`;
                warningElement.style.display = 'inline';
            } else if (quotaUsage >= WARNING_THRESHOLDS.LOW) {
                warningElement.textContent = `용량 한도 ${(quotaUsage * 100).toFixed(0)}% 사용`;
                warningElement.style.display = 'inline';
            } else {
                warningElement.style.display = 'none';
            }
        }
        
        // Enable/disable import button
        if (importBtn) {
            const canImport = count > 0 && newTotalSize <= QUOTA_LIMITS.PROJECT_QUOTA;
            importBtn.disabled = !canImport;
        }
        
        // Add event listeners to checkboxes
        document.querySelectorAll('.file-checkbox').forEach(checkbox => {
            checkbox.removeEventListener('change', updateOrgSelectionInfo);
            checkbox.addEventListener('change', updateOrgSelectionInfo);
        });
    }
    
    function importSelectedDocuments() {
        const checkboxes = document.querySelectorAll('.file-checkbox:checked');
        const selectedFiles = [];
        
        checkboxes.forEach(checkbox => {
            const fileElement = checkbox.closest('.org-file');
            const fileName = fileElement.querySelector('.file-name').textContent;
            const fileSize = fileElement.querySelector('.file-meta').textContent.split(' ')[0];
            selectedFiles.push({
                name: fileName,
                size: fileSize
            });
        });
        
        if (selectedFiles.length === 0) {
            alert('선택된 문서가 없습니다.');
            return;
        }
        
        // Show loading state
        const importBtn = document.getElementById('importBtn');
        const originalText = importBtn.textContent;
        importBtn.textContent = '불러오는 중...';
        importBtn.disabled = true;
        
        // Simulate import process
        setTimeout(() => {
            // Add files to project documents
            const project = projects.find(p => p.id === currentProject);
            if (project && !project.documents.organization) {
                project.documents.organization = [];
            }
            
            selectedFiles.forEach(file => {
                project.documents.organization.push({
                    name: file.name,
                    type: 'file',
                    size: file.size,
                    importDate: new Date().toISOString().split('T')[0],
                    source: 'organization'
                });
            });
            
            // Update project storage usage
            const totalImportSize = selectedFiles.reduce((sum, file) => {
                return sum + parseFloat(file.size.replace('MB', '') || 0);
            }, 0);
            project.storage.used += totalImportSize;
            
            // Update UI
            updateCapacityDisplay(currentProject);
            renderSidebar();
            
            // Close modal
            closeModal();
            
            // Show success message
            alert(`${selectedFiles.length}개 조직 문서를 성공적으로 불러왔습니다.`);
        }, 1200);
    }
    
    // Personal upload functions
    let selectedDirectory = '';
    
    function selectDirectory(dirPath, element) {
        selectedDirectory = dirPath;
        
        // Update UI to show selected directory
        document.querySelectorAll('.directory-item').forEach(item => {
            item.classList.remove('selected');
        });
        
        // Use provided element or try to get from event
        const targetElement = element || (window.event && window.event.target ? window.event.target.closest('.directory-item') : null);
        if (targetElement) {
            targetElement.classList.add('selected');
        }
        
        // Enable next button
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            nextBtn.disabled = false;
        }
    }
    
    function createNewDirectory() {
        const input = document.getElementById('newDirName');
        const dirName = input.value.trim();
        
        if (!dirName) {
            WeraserCore.ui.showNotification('디렉토리 이름을 입력하세요', 'warning');
            return;
        }
        
        const fullPath = `/개인문서/${dirName}`;
        selectedDirectory = fullPath;
        
        // Add new directory to list
        const dirList = document.querySelector('.directory-list');
        const newDirElement = document.createElement('div');
        newDirElement.className = 'directory-item selected';
        newDirElement.onclick = () => selectDirectory(fullPath, newDirElement);
        newDirElement.innerHTML = `
            <span class="folder-icon">📁</span>
            <span>${fullPath}</span>
            <span class="dir-count">(0개)</span>
        `;
        
        dirList.appendChild(newDirElement);
        
        // Clear other selections
        document.querySelectorAll('.directory-item').forEach(item => {
            if (item !== newDirElement) {
                item.classList.remove('selected');
            }
        });
        
        // Enable next button and clear input
        const nextBtn = document.getElementById('nextBtn');
        if (nextBtn) {
            nextBtn.disabled = false;
        }
        input.value = '';
        
        WeraserCore.ui.showNotification(`디렉토리 "${dirName}" 생성 완료`, 'success');
    }
    
    function nextStep() {
        if (!selectedDirectory) {
            WeraserCore.ui.showNotification('디렉토리를 선택하세요', 'warning');
            return;
        }
        
        // Hide directory step, show file step
        document.getElementById('directoryStep').style.display = 'none';
        document.getElementById('fileStep').style.display = 'block';
        document.getElementById('selectedDirPath').textContent = selectedDirectory;
        
        // Update buttons
        document.getElementById('nextBtn').style.display = 'none';
        document.getElementById('uploadBtn').style.display = 'inline-block';
    }
    
    function triggerFileSelect() {
        document.getElementById('fileInput').click();
    }
    
    function handleDragOver(event) {
        event.preventDefault();
        event.currentTarget.classList.add('dragover');
    }
    
    function handleFileDrop(event) {
        event.preventDefault();
        event.currentTarget.classList.remove('dragover');
        const files = event.dataTransfer.files;
        handleFiles(files);
    }
    
    function handleFileSelect(event) {
        const files = event.target.files;
        handleFiles(files);
    }
    
    function handleFiles(files) {
        if (files.length === 0) return;
        
        // Validate files
        const validation = validateFileUpload(files, currentProject);
        
        // Update upload area to show selected files
        const uploadArea = document.querySelector('.file-upload-area');
        let validationHTML = '';
        
        if (validation.errors.length > 0) {
            validationHTML += `
                <div class="validation-error">
                    <strong>업로드 불가:</strong><br>
                    ${validation.errors.map(error => `• ${error}`).join('<br>')}
                </div>
            `;
        }
        
        if (validation.warnings.length > 0) {
            validationHTML += `
                <div style="color: #f59e0b; font-size: 12px; margin-top: 8px; padding: 8px; background: #fffbeb; border-radius: 4px; border: 1px solid #fed7aa;">
                    <strong>주의:</strong><br>
                    ${validation.warnings.map(warning => `• ${warning}`).join('<br>')}
                </div>
            `;
        }
        
        uploadArea.innerHTML = `
            <div class="selected-files">
                <h5>선택된 파일 (${files.length}개)</h5>
                ${Array.from(files).map(file => `
                    <div class="file-item">
                        <span class="file-icon">${getFileIcon(file.name)}</span>
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">${(file.size / (1024 * 1024)).toFixed(1)}MB</span>
                    </div>
                `).join('')}
                ${validationHTML}
                <button class="btn-secondary" onclick="resetFileSelection()" style="margin-top: 10px;">다시 선택</button>
            </div>
        `;
        
        // Update upload info
        const uploadInfo = document.getElementById('uploadInfo');
        const fileCount = document.getElementById('fileCount');
        const totalUploadSize = document.getElementById('totalUploadSize');
        const quotaWarning = document.getElementById('quotaWarning');
        
        if (uploadInfo) uploadInfo.style.display = 'flex';
        if (fileCount) fileCount.textContent = `파일: ${files.length}개`;
        if (totalUploadSize) totalUploadSize.textContent = `크기: ${validation.newSize.toFixed(1)}MB`;
        
        if (quotaWarning) {
            if (validation.quotaUsage >= WARNING_THRESHOLDS.HIGH) {
                quotaWarning.textContent = `용량 한도 ${(validation.quotaUsage * 100).toFixed(0)}% 사용`;
                quotaWarning.style.display = 'inline';
            } else if (validation.quotaUsage >= WARNING_THRESHOLDS.LOW) {
                quotaWarning.textContent = `용량 한도 ${(validation.quotaUsage * 100).toFixed(0)}% 사용`;
                quotaWarning.style.display = 'inline';
            } else {
                quotaWarning.style.display = 'none';
            }
        }
        
        // Enable/disable upload button
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn) {
            uploadBtn.disabled = !validation.valid;
        }
    }
    
    function resetFileSelection() {
        const uploadArea = document.querySelector('.file-upload-area');
        uploadArea.innerHTML = `
            <div class="upload-icon">📤</div>
            <div class="upload-text">파일을 드래그하여 놓거나 클릭하여 선택하세요</div>
            <div class="upload-formats">지원 형식: PDF, Word, Excel, PPT, 이미지, 텍스트</div>
        `;
        
        uploadArea.onclick = triggerFileSelect;
        
        // Disable upload button
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn) {
            uploadBtn.disabled = true;
        }
        
        // Reset file input
        document.getElementById('fileInput').value = '';
    }
    
    function executeUpload() {
        const files = document.getElementById('fileInput').files;
        if (!files || files.length === 0) {
            WeraserCore.ui.showNotification('업로드할 파일을 선택하세요', 'warning');
            return;
        }
        
        // Final validation
        const validation = validateFileUpload(files, currentProject);
        if (!validation.valid) {
            WeraserCore.ui.showNotification('업로드 조건을 확인해주세요', 'error');
            return;
        }
        
        WeraserCore.ui.showNotification(`${files.length}개 파일을 ${selectedDirectory}에 업로드 중...`, 'info');
        
        // Simulate upload process and actually add to project data
        setTimeout(() => {
            const project = projects.find(p => p.id === currentProject);
            if (project) {
                // Initialize personal documents array if not exists
                if (!project.documents.personal) {
                    project.documents.personal = [];
                }
                
                // Check if directory folder exists, create if not
                let directoryFolder = project.documents.personal.find(item => 
                    item.type === 'folder' && item.path === selectedDirectory
                );
                
                if (!directoryFolder) {
                    directoryFolder = {
                        type: 'folder',
                        name: selectedDirectory.split('/').pop(),
                        path: selectedDirectory,
                        files: []
                    };
                    project.documents.personal.push(directoryFolder);
                }
                
                // Add files to directory
                Array.from(files).forEach(file => {
                    const fileData = {
                        name: file.name,
                        size: (file.size / (1024 * 1024)).toFixed(1) + 'MB',
                        uploadDate: new Date().toISOString().slice(0, 16).replace('T', ' '),
                        type: file.type || 'application/octet-stream'
                    };
                    
                    directoryFolder.files.push(fileData);
                });
                
                // Update document count
                project.documentCount += files.length;
                
                WeraserCore.ui.showNotification(`${files.length}개 개인 문서 업로드 완료`, 'success');
                
                // Update capacity display and sidebar
                updateCapacityDisplay(currentProject);
                renderSidebar();
            }
            
            closeModal();
        }, 1500);
    }
    
    // Select document and show artifact view
    function selectDocument(path, type, metadataStr) {
        console.log('selectDocument called with:', path, type, metadataStr);
        const project = projects.find(p => p.id === currentProject);
        if (!project) {
            console.log('No project found');
            return;
        }
        
        // Parse metadata if provided
        let metadata = null;
        if (metadataStr) {
            try {
                metadata = JSON.parse(metadataStr.replace(/&#39;/g, "'").replace(/&quot;/g, '"'));
                console.log('Parsed metadata:', metadata);
            } catch (e) {
                console.error('Failed to parse metadata:', e);
            }
        }
        
        // Show artifact panel
        console.log('Calling showArtifactPanel...');
        showArtifactPanel(path, type, metadata);
        
        // Highlight selected document
        document.querySelectorAll('.doc-item').forEach(item => {
            item.classList.remove('selected');
        });
        if (event && event.currentTarget) {
            event.currentTarget.classList.add('selected');
        }
    }
    
    // Show artifact panel
    function showArtifactPanel(documentPath, documentType, metadata) {
        console.log('showArtifactPanel called with:', documentPath, documentType, metadata);
        // Remove existing panel if any
        let panel = document.querySelector('.artifact-panel');
        if (!panel) {
            console.log('Creating new artifact panel');
            panel = document.createElement('div');
            panel.className = 'artifact-panel';
            document.body.appendChild(panel);
        } else {
            console.log('Using existing panel');
        }
        
        // Get file name and extension
        const fileName = documentPath.split('/').pop();
        const fileExt = fileName.split('.').pop().toUpperCase();
        
        // Build metadata section
        let metaSection = '';
        if (metadata) {
            metaSection = `
                <h4>📊 메타정보</h4>
                <table style="width: 100%; font-size: 13px; margin: 10px 0;">
                    ${metadata.updateDate ? `
                        <tr>
                            <td style="padding: 6px; color: #787774; width: 30%;">업데이트 일시:</td>
                            <td style="padding: 6px;">${metadata.updateDate}</td>
                        </tr>
                        <tr>
                            <td style="padding: 6px; color: #787774;">업데이트 담당자:</td>
                            <td style="padding: 6px;">${metadata.updater}</td>
                        </tr>
                    ` : ''}
                    ${metadata.uploadDate ? `
                        <tr>
                            <td style="padding: 6px; color: #787774; width: 30%;">업로드 일시:</td>
                            <td style="padding: 6px;">${metadata.uploadDate}</td>
                        </tr>
                    ` : ''}
                    ${metadata.size ? `
                        <tr>
                            <td style="padding: 6px; color: #787774;">파일 크기:</td>
                            <td style="padding: 6px;">${metadata.size}</td>
                        </tr>
                    ` : ''}
                    <tr>
                        <td style="padding: 6px; color: #787774;">문서 유형:</td>
                        <td style="padding: 6px;">${getFileIcon(fileName)} ${fileExt}</td>
                    </tr>
                </table>
            `;
        }
        
        // Mock document content
        const mockDocumentContent = `
            <h4>📄 문서 내용</h4>
            <div style="background: #f7f7f5; padding: 15px; border-radius: 6px; margin: 10px 0; font-size: 14px; line-height: 1.8;">
                ${documentPath.includes('계약') ? `
                    <p><strong>1. 계약 개요</strong></p>
                    <p>• 계약명: H-Line 수출 공급 계약</p>
                    <p>• 계약기간: 2024.01.01 ~ 2024.12.31</p>
                    <p>• 계약금액: USD 5,000,000</p>
                    <br>
                    <p><strong>2. 주요 조항</strong></p>
                    <p>• 납품 일정: 분기별 나누어 납품</p>
                    <p>• 품질 보증: ISO 9001 기준 충족</p>
                    <p>• 결제 조건: L/C at sight</p>
                ` : documentPath.includes('관세') ? `
                    <p><strong>HS 코드 분류 체계</strong></p>
                    <p>• 8708.99: 기타 자동차 부품 - 관세율 8%</p>
                    <p>• 8708.30: 브레이크 및 서보브레이크 - 관세율 8%</p>
                    <p>• 8708.40: 기어박스 - 관세율 8%</p>
                    <br>
                    <p><strong>FTA 활용 시 혜택</strong></p>
                    <p>• 한-EU FTA: 즉시 철폐 또는 5년 내 단계적 철폐</p>
                    <p>• 한-미 FTA: 즉시 철폐 또는 5년 내 단계적 철폐</p>
                ` : documentPath.includes('법무') ? `
                    <p><strong>수출입 관련 주요 법령</strong></p>
                    <p>• 대외무역법: 수출입 기본 법령</p>
                    <p>• 관세법: 관세 부과 및 징수</p>
                    <p>• 외국환거래법: 외환 거래 규정</p>
                    <br>
                    <p><strong>FTA 활용 가이드</strong></p>
                    <p>• 원산지 결정 기준</p>
                    <p>• 원산지 증명서 발급 절차</p>
                    <p>• FTA별 특혜 관세율</p>
                ` : `
                    <p>이 문서의 상세 내용이 여기에 표시됩니다.</p>
                    <p>실제 시스템에서는 문서의 전체 내용이 표시되며,</p>
                    <p>텍스트 검색 및 하이라이트 기능이 제공됩니다.</p>
                `}
            </div>
        `;
        
        const mockContent = `
            <h3>📄 ${fileName}</h3>
            <p><strong>경로:</strong> ${documentPath}</p>
            <hr style="margin: 16px 0; border: none; border-top: 1px solid #e9e9e7;">
            ${metaSection}
            ${mockDocumentContent}
            <h4>🎯 키워드</h4>
            <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;">
                <span style="padding: 4px 8px; background: #e6f7ff; border-radius: 4px; font-size: 12px;">수출</span>
                <span style="padding: 4px 8px; background: #e6f7ff; border-radius: 4px; font-size: 12px;">계약</span>
                <span style="padding: 4px 8px; background: #e6f7ff; border-radius: 4px; font-size: 12px;">H-Line</span>
                <span style="padding: 4px 8px; background: #e6f7ff; border-radius: 4px; font-size: 12px;">2024</span>
            </div>
        `;
        
        panel.innerHTML = `
            <div class="artifact-header">
                <div class="artifact-title">문서 상세</div>
                <div class="artifact-close" onclick="closeArtifactPanel()">✕</div>
            </div>
            <div class="artifact-content">
                ${mockContent}
            </div>
            <div class="artifact-meta">
                ${documentType === 'org' ? '🔄 자동 동기화 활성' : '👤 개인 문서'} | 
                ${metadata ? (metadata.updateDate || metadata.uploadDate || '마지막 업데이트: 방금 전') : '마지막 업데이트: 방금 전'}
            </div>
        `;
        
        console.log('Adding visible class to panel');
        panel.classList.add('visible');
        console.log('Panel classes:', panel.className);
    }
    
    // Close artifact panel
    function closeArtifactPanel() {
        const panel = document.querySelector('.artifact-panel');
        if (panel) {
            panel.classList.remove('visible');
        }
    }
    
    // Show document
    function showDocument(filename) {
        WeraserCore.ui.showNotification(`문서 '${filename}' 열기`, 'info');
        // TODO: Open document viewer
    }
    
    // Legacy closeModal function - replaced by modal overlay system
    // (removed to prevent conflicts)
    
    // Rename chat
    function renameChat() {
        const project = projects.find(p => p.id === currentProject);
        const chat = project.chats.find(c => c.id === currentChat);
        const newName = prompt('새 채팅 이름:', chat.title);
        if (newName && newName !== chat.title) {
            chat.title = newName;
            renderSidebar();
            updateBreadcrumb();
            WeraserCore.ui.showNotification('채팅 이름 변경됨', 'success');
        }
    }
    
    // Delete chat
    function deleteChat() {
        if (confirm('이 채팅을 삭제하시겠습니까?')) {
            const project = projects.find(p => p.id === currentProject);
            const chatIndex = project.chats.findIndex(c => c.id === currentChat);
            project.chats.splice(chatIndex, 1);
            
            // Show welcome or first chat
            if (project.chats.length > 0) {
                selectChat(currentProject, project.chats[0].id);
            } else {
                currentChat = null;
                showProjectWelcome(currentProject);
            }
            
            renderSidebar();
            WeraserCore.ui.showNotification('채팅 삭제됨', 'success');
        }
    }
    
    // Data persistence functions
    function saveDataToLocalStorage() {
        try {
            // Save projects
            localStorage.setItem('weraser_projects', JSON.stringify(projects));
            
            // Save organization directories
            localStorage.setItem('weraser_org_directories', JSON.stringify(organizationDirectories));
            
            // Save current user
            localStorage.setItem('weraser_current_user', JSON.stringify(currentUser));
            
            console.log('Data saved to localStorage');
        } catch (error) {
            console.error('Failed to save data to localStorage:', error);
        }
    }
    
    function loadDataFromLocalStorage() {
        try {
            // Load projects
            const savedProjects = localStorage.getItem('weraser_projects');
            if (savedProjects) {
                projects = JSON.parse(savedProjects);
                console.log('Projects loaded from localStorage');
            }
            
            // Load organization directories
            const savedOrgDirs = localStorage.getItem('weraser_org_directories');
            if (savedOrgDirs) {
                organizationDirectories = JSON.parse(savedOrgDirs);
                console.log('Organization directories loaded from localStorage');
            }
            
            // Load current user
            const savedUser = localStorage.getItem('weraser_current_user');
            if (savedUser) {
                const parsedUser = JSON.parse(savedUser);
                // Ensure the user has admin role for testing
                parsedUser.role = userRoles.ADMIN;
                currentUser = parsedUser;
                // Save the updated user back to localStorage
                localStorage.setItem('weraser_current_user', JSON.stringify(currentUser));
                console.log('Current user loaded from localStorage with admin role');
            } else {
                // If no saved user, save the default admin user
                localStorage.setItem('weraser_current_user', JSON.stringify(currentUser));
                console.log('Default admin user saved to localStorage');
            }
        } catch (error) {
            console.error('Failed to load data from localStorage:', error);
        }
    }
    
    // Auto-save data on changes
    function autoSaveData() {
        saveDataToLocalStorage();
    }
    
    // Go to admin
    function goToAdmin() {
        // Check user permission
        if (currentUser.role !== userRoles.ADMIN && currentUser.role !== userRoles.MANAGER) {
            alert('관리자 권한이 필요합니다.');
            return;
        }
        
        // Navigate to admin page
        window.location.href = 'admin-dashboard.html';
    }
    
    // Show profile
    function showProfile() {
        WeraserCore.ui.showNotification('프로필 화면 표시', 'info');
    }
    
    // Show directory management modal
    function showDirectoryManagement() {
        // Remove any existing modals
        const existingModals = document.querySelectorAll('.modal, .modal-overlay');
        existingModals.forEach(modal => modal.remove());
        
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'modal show';
        modal.innerHTML = `
            <div class="modal-container" style="width: 80%; max-width: 1000px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: none;">
                <div class="modal-header">
                    <div class="modal-header-content">
                        <div>
                            <h3>⚙️ 디렉토리 관리</h3>
                            <div style="font-size: 12px; color: #787774; margin-top: 4px;">
                                조직 문서 디렉토리를 관리하고 권한을 설정합니다
                            </div>
                        </div>
                        <button class="modal-close" onclick="closeModal()">&times;</button>
                    </div>
                </div>
                <div class="modal-content" style="padding: 24px; flex: 1; overflow-y: auto; display: flex; flex-direction: column;">
                    <!-- Tab Navigation -->
                    <div style="display: flex; gap: 20px; border-bottom: 1px solid #e9e9e7; margin-bottom: 20px;">
                        <div id="orgDirTab" onclick="switchDirectoryTab('organization')" 
                             style="padding: 12px 0; cursor: pointer; border-bottom: 2px solid #007acc; color: #007acc; font-weight: 500;">
                            조직 디렉토리
                        </div>
                        <div id="personalDirTab" onclick="switchDirectoryTab('personal')" 
                             style="padding: 12px 0; cursor: pointer; color: #787774;">
                            개인 디렉토리 설정
                        </div>
                    </div>
                    
                    <!-- Organization Directory Management -->
                    <div id="orgDirContent" style="display: flex; flex-direction: column; gap: 20px;">
                        <!-- Add New Directory -->
                        <div style="display: flex; gap: 10px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                            <input type="text" id="newOrgDirName" placeholder="새 디렉토리 이름" 
                                   style="flex: 1; padding: 10px; border: 1px solid #e9e9e7; border-radius: 6px;">
                            <button class="btn-primary" onclick="addOrganizationDirectory()">
                                ➕ 디렉토리 추가
                            </button>
                        </div>
                        
                        <!-- Directory List -->
                        <div id="orgDirList" style="flex: 1;">
                            ${renderOrganizationDirectories()}
                        </div>
                    </div>
                    
                    <!-- Personal Directory Settings (Hidden by default) -->
                    <div id="personalDirContent" style="display: none; flex-direction: column; gap: 20px;">
                        <div style="padding: 20px; background: #f8f9fa; border-radius: 8px; text-align: center;">
                            <h4 style="margin: 0 0 10px 0;">개인 디렉토리 정책 설정</h4>
                            <p style="color: #787774; margin: 0;">사용자별 개인 디렉토리 생성 권한 및 용량 제한을 설정합니다</p>
                            <div style="margin-top: 20px; display: flex; gap: 20px; justify-content: center;">
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    <input type="checkbox" id="allowPersonalDirCreation" checked>
                                    사용자 디렉토리 생성 허용
                                </label>
                                <label style="display: flex; align-items: center; gap: 8px;">
                                    최대 용량:
                                    <input type="number" id="personalQuotaLimit" value="1024" 
                                           style="width: 100px; padding: 4px 8px; border: 1px solid #e9e9e7; border-radius: 4px;">
                                    MB
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer" style="padding: 16px 20px; border-top: 1px solid #e9e9e7; display: flex; justify-content: flex-end;">
                    <button class="btn-secondary" onclick="closeModal()">닫기</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
    }
    
    // Render organization directories
    function renderOrganizationDirectories() {
        if (organizationDirectories.length === 0) {
            return '<div style="text-align: center; padding: 40px; color: #787774;">등록된 디렉토리가 없습니다</div>';
        }
        
        return organizationDirectories.map(dir => `
            <div class="directory-item" style="display: flex; align-items: center; padding: 12px 16px; background: white; border: 1px solid #e9e9e7; border-radius: 8px; margin-bottom: 8px;">
                <span style="font-size: 20px; margin-right: 12px;">📁</span>
                <div style="flex: 1;">
                    <div style="font-weight: 500; color: #37352f;">${dir.name}</div>
                    <div style="font-size: 12px; color: #787774; margin-top: 2px;">
                        ${dir.path} • ${dir.fileCount}개 파일 • 생성: ${dir.createdAt}
                    </div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button class="btn-secondary" onclick="editOrganizationDirectory('${dir.id}')" 
                            style="padding: 6px 12px; font-size: 12px;">
                        ✏️ 수정
                    </button>
                    <button class="btn-secondary" onclick="deleteOrganizationDirectory('${dir.id}')" 
                            style="padding: 6px 12px; font-size: 12px; color: #dc3545;">
                        🗑️ 삭제
                    </button>
                </div>
            </div>
        `).join('');
    }
    
    // Switch directory tab
    function switchDirectoryTab(tab) {
        const orgTab = document.getElementById('orgDirTab');
        const personalTab = document.getElementById('personalDirTab');
        const orgContent = document.getElementById('orgDirContent');
        const personalContent = document.getElementById('personalDirContent');
        
        if (tab === 'organization') {
            orgTab.style.borderBottom = '2px solid #007acc';
            orgTab.style.color = '#007acc';
            orgTab.style.fontWeight = '500';
            personalTab.style.borderBottom = 'none';
            personalTab.style.color = '#787774';
            personalTab.style.fontWeight = 'normal';
            
            orgContent.style.display = 'flex';
            personalContent.style.display = 'none';
        } else {
            personalTab.style.borderBottom = '2px solid #007acc';
            personalTab.style.color = '#007acc';
            personalTab.style.fontWeight = '500';
            orgTab.style.borderBottom = 'none';
            orgTab.style.color = '#787774';
            orgTab.style.fontWeight = 'normal';
            
            personalContent.style.display = 'flex';
            orgContent.style.display = 'none';
        }
    }
    
    // Add organization directory
    function addOrganizationDirectory() {
        const nameInput = document.getElementById('newOrgDirName');
        const dirName = nameInput.value.trim();
        
        if (!dirName) {
            alert('디렉토리 이름을 입력하세요.');
            return;
        }
        
        // Check for duplicate names
        if (organizationDirectories.some(dir => dir.name === dirName)) {
            alert('이미 존재하는 디렉토리 이름입니다.');
            return;
        }
        
        // Create new directory
        const newDir = {
            id: `org-dir-${Date.now()}`,
            name: dirName,
            path: `/조직문서/${dirName}`,
            type: 'organization',
            permissions: ['admin', 'manager'],
            createdBy: currentUser.name,
            createdAt: new Date().toISOString().split('T')[0],
            fileCount: 0,
            children: []
        };
        
        organizationDirectories.push(newDir);
        autoSaveData();
        
        // Update UI
        const dirList = document.getElementById('orgDirList');
        dirList.innerHTML = renderOrganizationDirectories();
        
        // Clear input
        nameInput.value = '';
        
        alert(`"${dirName}" 디렉토리가 생성되었습니다.`);
    }
    
    // Edit organization directory
    function editOrganizationDirectory(dirId) {
        const dir = organizationDirectories.find(d => d.id === dirId);
        if (!dir) return;
        
        const newName = prompt('새 디렉토리 이름:', dir.name);
        if (!newName || newName === dir.name) return;
        
        // Check for duplicate names
        if (organizationDirectories.some(d => d.id !== dirId && d.name === newName)) {
            alert('이미 존재하는 디렉토리 이름입니다.');
            return;
        }
        
        // Update directory
        dir.name = newName;
        dir.path = `/조직문서/${newName}`;
        autoSaveData();
        
        // Update UI
        const dirList = document.getElementById('orgDirList');
        if (dirList) {
            dirList.innerHTML = renderOrganizationDirectories();
        }
        
        alert(`디렉토리 이름이 "${newName}"로 변경되었습니다.`);
    }
    
    // Delete organization directory
    function deleteOrganizationDirectory(dirId) {
        const dir = organizationDirectories.find(d => d.id === dirId);
        if (!dir) return;
        
        if (!confirm(`"${dir.name}" 디렉토리를 삭제하시겠습니까?\n\n⚠️ 주의: ${dir.fileCount}개의 파일이 포함되어 있습니다.`)) {
            return;
        }
        
        // Remove directory
        organizationDirectories = organizationDirectories.filter(d => d.id !== dirId);
        autoSaveData();
        
        // Update UI
        const dirList = document.getElementById('orgDirList');
        if (dirList) {
            dirList.innerHTML = renderOrganizationDirectories();
        }
        
        alert(`"${dir.name}" 디렉토리가 삭제되었습니다.`);
    }
</script>
</body>
</html>