<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Engine Debug - Weraser</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #d39e00; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #bd2130; }
        
        .log-container {
            background: #212529;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            margin: 20px 0;
        }
        .search-section {
            margin: 20px 0;
            padding: 20px;
            background: #d4edda;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 16px;
            margin: 10px 0;
        }
        .search-results {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            min-height: 100px;
        }
        .result-item {
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
            border-left: 4px solid #17a2b8;
            border-radius: 4px;
        }
        .result-meta {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 Vector Engine Debug Console</h1>
            <div>
                <button class="btn btn-warning" onclick="location.href='index.html'">← 메인으로</button>
            </div>
        </div>

        <!-- Status Dashboard -->
        <div class="status-grid" id="statusGrid">
            <div class="status-card">
                <h3>벡터 엔진 상태</h3>
                <div class="status-value" id="engineStatus">초기화 중...</div>
            </div>
            <div class="status-card">
                <h3>인덱싱된 문서</h3>
                <div class="status-value" id="documentCount">0</div>
            </div>
            <div class="status-card">
                <h3>총 청크 수</h3>
                <div class="status-value" id="chunkCount">0</div>
            </div>
            <div class="status-card">
                <h3>캐시 크기</h3>
                <div class="status-value" id="cacheSize">0</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" onclick="initializeEngine()">🚀 엔진 초기화</button>
            <button class="btn btn-success" onclick="refreshStatus()">🔄 상태 새로고침</button>
            <button class="btn btn-warning" onclick="testDummyDocuments()">📄 더미 문서 인덱싱</button>
            <button class="btn btn-danger" onclick="clearIndex()">🗑️ 인덱스 초기화</button>
        </div>

        <!-- Test Document Indexing -->
        <div class="test-section">
            <h3>📚 문서 인덱싱 테스트</h3>
            <p>더미 문서들을 인덱싱하여 벡터 검색 시스템을 테스트합니다.</p>
            <div class="controls">
                <button class="btn btn-success" onclick="indexTestDocument('매출보고서')">매출보고서 인덱싱</button>
                <button class="btn btn-success" onclick="indexTestDocument('프로젝트계획서')">프로젝트계획서 인덱싱</button>
                <button class="btn btn-success" onclick="indexTestDocument('관세분류표')">관세분류표 인덱싱</button>
            </div>
        </div>

        <!-- Semantic Search Test -->
        <div class="search-section">
            <h3>🔍 의미 검색 테스트</h3>
            <input type="text" class="search-input" id="searchInput" placeholder="검색할 질문을 입력하세요... (예: 현재 매출은 얼마인가요?)" />
            <div class="controls">
                <button class="btn btn-primary" onclick="performSearch()">검색 실행</button>
                <button class="btn btn-success" onclick="performRAGQuery()">RAG 쿼리 실행</button>
            </div>
            <div class="search-results" id="searchResults">
                <p style="color: #6c757d; text-align: center;">검색 결과가 여기에 표시됩니다.</p>
            </div>
        </div>

        <!-- Console Log -->
        <div class="log-container" id="logContainer">
            <div style="color: #28a745;">✅ Vector Engine Debug Console 시작됨</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="vector-engine.js"></script>
    <script>
        // 로그 함수
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#ffffff',
                success: '#28a745',
                warning: '#ffc107',
                error: '#dc3545'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type];
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 엔진 초기화
        async function initializeEngine() {
            addLog('🚀 벡터 엔진 초기화 시작...', 'info');
            try {
                const result = await window.VectorEngine.initialize();
                if (result.success) {
                    addLog('✅ 벡터 엔진 초기화 성공', 'success');
                    refreshStatus();
                } else {
                    addLog(`❌ 벡터 엔진 초기화 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`❌ 초기화 중 오류: ${error.message}`, 'error');
            }
        }

        // 상태 새로고침
        function refreshStatus() {
            if (!window.VectorEngine) {
                addLog('❌ 벡터 엔진이 로드되지 않음', 'error');
                return;
            }

            const status = window.VectorEngine.getIndexStatus();
            
            document.getElementById('engineStatus').textContent = status.isInitialized ? '✅ 활성화' : '❌ 비활성화';
            document.getElementById('documentCount').textContent = status.totalDocuments;
            document.getElementById('chunkCount').textContent = status.totalChunks;
            document.getElementById('cacheSize').textContent = status.cacheSize;

            addLog(`📊 상태 업데이트: 문서 ${status.totalDocuments}개, 청크 ${status.totalChunks}개`, 'info');
        }

        // 더미 문서들 인덱싱
        async function testDummyDocuments() {
            addLog('📄 더미 문서들 일괄 인덱싱 시작...', 'info');
            const documents = ['매출보고서', '프로젝트계획서', '관세분류표'];
            
            for (const docName of documents) {
                await indexTestDocument(docName, false);
                await new Promise(resolve => setTimeout(resolve, 500)); // 0.5초 대기
            }
            
            addLog('✅ 더미 문서들 일괄 인덱싱 완료', 'success');
            refreshStatus();
        }

        // 테스트 문서 인덱싱
        async function indexTestDocument(docType, shouldRefresh = true) {
            if (!window.VectorEngine || !window.VectorEngine.initialized) {
                addLog('❌ 벡터 엔진이 초기화되지 않음', 'error');
                return;
            }

            const testDocuments = {
                '매출보고서': {
                    name: 'Q3_매출보고서.xlsx',
                    type: 'xlsx',
                    size: 2048000
                },
                '프로젝트계획서': {
                    name: '2024_프로젝트계획서.docx',
                    type: 'docx',
                    size: 1536000
                },
                '관세분류표': {
                    name: 'HS_관세분류표.pdf',
                    type: 'pdf',
                    size: 3072000
                }
            };

            const doc = testDocuments[docType];
            if (!doc) {
                addLog(`❌ 알 수 없는 문서 타입: ${docType}`, 'error');
                return;
            }

            addLog(`📄 "${doc.name}" 인덱싱 시작...`, 'info');
            
            try {
                const result = await window.VectorEngine.indexDocument(doc);
                if (result.success) {
                    addLog(`✅ "${doc.name}" 인덱싱 완료 (${result.chunks}개 청크, ${result.processingTime.toFixed(2)}초)`, 'success');
                    if (shouldRefresh) refreshStatus();
                } else {
                    addLog(`❌ "${doc.name}" 인덱싱 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`❌ 인덱싱 중 오류: ${error.message}`, 'error');
            }
        }

        // 의미 검색 수행
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                addLog('❌ 검색 질문을 입력해주세요', 'warning');
                return;
            }

            if (!window.VectorEngine || !window.VectorEngine.initialized) {
                addLog('❌ 벡터 엔진이 초기화되지 않음', 'error');
                return;
            }

            addLog(`🔍 의미 검색 시작: "${query}"`, 'info');
            
            try {
                const result = await window.VectorEngine.semanticSearch(query, {
                    topK: 5,
                    minSimilarity: 0.5
                });

                if (result.success) {
                    addLog(`✅ 의미 검색 완료: ${result.results.length}개 결과`, 'success');
                    displaySearchResults(result.results, 'search');
                } else {
                    addLog(`❌ 의미 검색 실패: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`❌ 검색 중 오류: ${error.message}`, 'error');
            }
        }

        // RAG 쿼리 수행
        async function performRAGQuery() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                addLog('❌ 검색 질문을 입력해주세요', 'warning');
                return;
            }

            if (!window.VectorEngine || !window.VectorEngine.initialized) {
                addLog('❌ 벡터 엔진이 초기화되지 않음', 'error');
                return;
            }

            addLog(`🤖 RAG 쿼리 시작: "${query}"`, 'info');
            
            try {
                // 1. 의미 검색
                const searchResult = await window.VectorEngine.semanticSearch(query, {
                    topK: 3,
                    minSimilarity: 0.6
                });

                if (searchResult.success && searchResult.results.length > 0) {
                    // 2. RAG 응답 생성
                    const ragResponse = await window.VectorEngine.generateRAGResponse(query, searchResult.results);
                    
                    if (ragResponse.success) {
                        addLog(`✅ RAG 응답 생성 완료 (컨텍스트: ${ragResponse.contextChunks}개)`, 'success');
                        displaySearchResults([{
                            response: ragResponse.response,
                            sources: ragResponse.sources,
                            confidence: ragResponse.confidence,
                            type: 'rag'
                        }], 'rag');
                    } else {
                        addLog(`❌ RAG 응답 생성 실패: ${ragResponse.error}`, 'error');
                    }
                } else {
                    addLog('❌ RAG를 위한 관련 문서를 찾을 수 없음', 'warning');
                    displaySearchResults([], 'rag');
                }
            } catch (error) {
                addLog(`❌ RAG 쿼리 중 오류: ${error.message}`, 'error');
            }
        }

        // 검색 결과 표시
        function displaySearchResults(results, type) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">검색 결과가 없습니다.</p>';
                return;
            }

            let html = '';
            
            if (type === 'rag' && results[0].type === 'rag') {
                // RAG 응답 표시
                const result = results[0];
                html = `
                    <div class="result-item" style="border-left-color: #28a745;">
                        <strong>🤖 AI 응답:</strong>
                        <p style="margin: 10px 0;">${result.response}</p>
                        <div class="result-meta">
                            출처: ${result.sources.join(', ')} | 신뢰도: ${(result.confidence * 100).toFixed(1)}%
                        </div>
                    </div>
                `;
            } else {
                // 벡터 검색 결과 표시
                results.forEach((result, index) => {
                    html += `
                        <div class="result-item">
                            <strong>${index + 1}. ${result.documentName}</strong>
                            <p style="margin: 5px 0;">${result.text}</p>
                            <div class="result-meta">
                                청크 ID: ${result.chunkId} | 유사도: ${(result.similarity * 100).toFixed(1)}% | 
                                위치: ${result.startPos}-${result.endPos}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // 인덱스 초기화
        async function clearIndex() {
            if (confirm('정말로 모든 벡터 인덱스를 초기화하시겠습니까?')) {
                try {
                    await window.VectorEngine.clearIndex();
                    addLog('🗑️ 벡터 인덱스 초기화 완료', 'warning');
                    refreshStatus();
                } catch (error) {
                    addLog(`❌ 인덱스 초기화 실패: ${error.message}`, 'error');
                }
            }
        }

        // 페이지 로드 시 자동 초기화
        window.addEventListener('load', async () => {
            addLog('🌐 페이지 로드됨', 'info');
            
            // 벡터 엔진이 로드될 때까지 대기
            let attempts = 0;
            while (!window.VectorEngine && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.VectorEngine) {
                addLog('✅ 벡터 엔진 로드됨', 'success');
                await initializeEngine();
            } else {
                addLog('❌ 벡터 엔진 로드 실패', 'error');
            }
        });

        // 엔터 키 검색 지원
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
</body>
</html>