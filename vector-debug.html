<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vector Engine Debug - Weraser</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 20px;
            background: #f8f9fa;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .status-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            border-left: 4px solid #007bff;
        }
        .status-card h3 {
            margin: 0 0 10px 0;
            color: #495057;
        }
        .status-value {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .test-section {
            margin: 30px 0;
            padding: 20px;
            background: #fff3cd;
            border-radius: 8px;
            border-left: 4px solid #ffc107;
        }
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #1e7e34; }
        .btn-warning { background: #ffc107; color: #212529; }
        .btn-warning:hover { background: #d39e00; }
        .btn-danger { background: #dc3545; color: white; }
        .btn-danger:hover { background: #bd2130; }
        
        .log-container {
            background: #212529;
            color: #fff;
            padding: 15px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 12px;
            margin: 20px 0;
        }
        .search-section {
            margin: 20px 0;
            padding: 20px;
            background: #d4edda;
            border-radius: 8px;
            border-left: 4px solid #28a745;
        }
        .search-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 16px;
            margin: 10px 0;
        }
        .search-results {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            min-height: 100px;
        }
        .result-item {
            padding: 10px;
            margin: 10px 0;
            background: #f8f9fa;
            border-left: 4px solid #17a2b8;
            border-radius: 4px;
        }
        .result-meta {
            font-size: 12px;
            color: #6c757d;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” Vector Engine Debug Console</h1>
            <div>
                <button class="btn btn-warning" onclick="location.href='index.html'">â† ë©”ì¸ìœ¼ë¡œ</button>
            </div>
        </div>

        <!-- Status Dashboard -->
        <div class="status-grid" id="statusGrid">
            <div class="status-card">
                <h3>ë²¡í„° ì—”ì§„ ìƒíƒœ</h3>
                <div class="status-value" id="engineStatus">ì´ˆê¸°í™” ì¤‘...</div>
            </div>
            <div class="status-card">
                <h3>ì¸ë±ì‹±ëœ ë¬¸ì„œ</h3>
                <div class="status-value" id="documentCount">0</div>
            </div>
            <div class="status-card">
                <h3>ì´ ì²­í¬ ìˆ˜</h3>
                <div class="status-value" id="chunkCount">0</div>
            </div>
            <div class="status-card">
                <h3>ìºì‹œ í¬ê¸°</h3>
                <div class="status-value" id="cacheSize">0</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" onclick="initializeEngine()">ğŸš€ ì—”ì§„ ì´ˆê¸°í™”</button>
            <button class="btn btn-success" onclick="refreshStatus()">ğŸ”„ ìƒíƒœ ìƒˆë¡œê³ ì¹¨</button>
            <button class="btn btn-warning" onclick="testDummyDocuments()">ğŸ“„ ë”ë¯¸ ë¬¸ì„œ ì¸ë±ì‹±</button>
            <button class="btn btn-danger" onclick="clearIndex()">ğŸ—‘ï¸ ì¸ë±ìŠ¤ ì´ˆê¸°í™”</button>
        </div>

        <!-- Test Document Indexing -->
        <div class="test-section">
            <h3>ğŸ“š ë¬¸ì„œ ì¸ë±ì‹± í…ŒìŠ¤íŠ¸</h3>
            <p>ë”ë¯¸ ë¬¸ì„œë“¤ì„ ì¸ë±ì‹±í•˜ì—¬ ë²¡í„° ê²€ìƒ‰ ì‹œìŠ¤í…œì„ í…ŒìŠ¤íŠ¸í•©ë‹ˆë‹¤.</p>
            <div class="controls">
                <button class="btn btn-success" onclick="indexTestDocument('ë§¤ì¶œë³´ê³ ì„œ')">ë§¤ì¶œë³´ê³ ì„œ ì¸ë±ì‹±</button>
                <button class="btn btn-success" onclick="indexTestDocument('í”„ë¡œì íŠ¸ê³„íšì„œ')">í”„ë¡œì íŠ¸ê³„íšì„œ ì¸ë±ì‹±</button>
                <button class="btn btn-success" onclick="indexTestDocument('ê´€ì„¸ë¶„ë¥˜í‘œ')">ê´€ì„¸ë¶„ë¥˜í‘œ ì¸ë±ì‹±</button>
            </div>
        </div>

        <!-- Semantic Search Test -->
        <div class="search-section">
            <h3>ğŸ” ì˜ë¯¸ ê²€ìƒ‰ í…ŒìŠ¤íŠ¸</h3>
            <input type="text" class="search-input" id="searchInput" placeholder="ê²€ìƒ‰í•  ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”... (ì˜ˆ: í˜„ì¬ ë§¤ì¶œì€ ì–¼ë§ˆì¸ê°€ìš”?)" />
            <div class="controls">
                <button class="btn btn-primary" onclick="performSearch()">ê²€ìƒ‰ ì‹¤í–‰</button>
                <button class="btn btn-success" onclick="performRAGQuery()">RAG ì¿¼ë¦¬ ì‹¤í–‰</button>
            </div>
            <div class="search-results" id="searchResults">
                <p style="color: #6c757d; text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</p>
            </div>
        </div>

        <!-- Console Log -->
        <div class="log-container" id="logContainer">
            <div style="color: #28a745;">âœ… Vector Engine Debug Console ì‹œì‘ë¨</div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="vector-engine.js"></script>
    <script>
        // ë¡œê·¸ í•¨ìˆ˜
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const timestamp = new Date().toLocaleTimeString();
            const colors = {
                info: '#ffffff',
                success: '#28a745',
                warning: '#ffc107',
                error: '#dc3545'
            };
            
            const logEntry = document.createElement('div');
            logEntry.style.color = colors[type];
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // ì—”ì§„ ì´ˆê¸°í™”
        async function initializeEngine() {
            addLog('ğŸš€ ë²¡í„° ì—”ì§„ ì´ˆê¸°í™” ì‹œì‘...', 'info');
            try {
                const result = await window.VectorEngine.initialize();
                if (result.success) {
                    addLog('âœ… ë²¡í„° ì—”ì§„ ì´ˆê¸°í™” ì„±ê³µ', 'success');
                    refreshStatus();
                } else {
                    addLog(`âŒ ë²¡í„° ì—”ì§„ ì´ˆê¸°í™” ì‹¤íŒ¨: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ìƒíƒœ ìƒˆë¡œê³ ì¹¨
        function refreshStatus() {
            if (!window.VectorEngine) {
                addLog('âŒ ë²¡í„° ì—”ì§„ì´ ë¡œë“œë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }

            const status = window.VectorEngine.getIndexStatus();
            
            document.getElementById('engineStatus').textContent = status.isInitialized ? 'âœ… í™œì„±í™”' : 'âŒ ë¹„í™œì„±í™”';
            document.getElementById('documentCount').textContent = status.totalDocuments;
            document.getElementById('chunkCount').textContent = status.totalChunks;
            document.getElementById('cacheSize').textContent = status.cacheSize;

            addLog(`ğŸ“Š ìƒíƒœ ì—…ë°ì´íŠ¸: ë¬¸ì„œ ${status.totalDocuments}ê°œ, ì²­í¬ ${status.totalChunks}ê°œ`, 'info');
        }

        // ë”ë¯¸ ë¬¸ì„œë“¤ ì¸ë±ì‹±
        async function testDummyDocuments() {
            addLog('ğŸ“„ ë”ë¯¸ ë¬¸ì„œë“¤ ì¼ê´„ ì¸ë±ì‹± ì‹œì‘...', 'info');
            const documents = ['ë§¤ì¶œë³´ê³ ì„œ', 'í”„ë¡œì íŠ¸ê³„íšì„œ', 'ê´€ì„¸ë¶„ë¥˜í‘œ'];
            
            for (const docName of documents) {
                await indexTestDocument(docName, false);
                await new Promise(resolve => setTimeout(resolve, 500)); // 0.5ì´ˆ ëŒ€ê¸°
            }
            
            addLog('âœ… ë”ë¯¸ ë¬¸ì„œë“¤ ì¼ê´„ ì¸ë±ì‹± ì™„ë£Œ', 'success');
            refreshStatus();
        }

        // í…ŒìŠ¤íŠ¸ ë¬¸ì„œ ì¸ë±ì‹±
        async function indexTestDocument(docType, shouldRefresh = true) {
            if (!window.VectorEngine || !window.VectorEngine.initialized) {
                addLog('âŒ ë²¡í„° ì—”ì§„ì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }

            const testDocuments = {
                'ë§¤ì¶œë³´ê³ ì„œ': {
                    name: 'Q3_ë§¤ì¶œë³´ê³ ì„œ.xlsx',
                    type: 'xlsx',
                    size: 2048000
                },
                'í”„ë¡œì íŠ¸ê³„íšì„œ': {
                    name: '2024_í”„ë¡œì íŠ¸ê³„íšì„œ.docx',
                    type: 'docx',
                    size: 1536000
                },
                'ê´€ì„¸ë¶„ë¥˜í‘œ': {
                    name: 'HS_ê´€ì„¸ë¶„ë¥˜í‘œ.pdf',
                    type: 'pdf',
                    size: 3072000
                }
            };

            const doc = testDocuments[docType];
            if (!doc) {
                addLog(`âŒ ì•Œ ìˆ˜ ì—†ëŠ” ë¬¸ì„œ íƒ€ì…: ${docType}`, 'error');
                return;
            }

            addLog(`ğŸ“„ "${doc.name}" ì¸ë±ì‹± ì‹œì‘...`, 'info');
            
            try {
                const result = await window.VectorEngine.indexDocument(doc);
                if (result.success) {
                    addLog(`âœ… "${doc.name}" ì¸ë±ì‹± ì™„ë£Œ (${result.chunks}ê°œ ì²­í¬, ${result.processingTime.toFixed(2)}ì´ˆ)`, 'success');
                    if (shouldRefresh) refreshStatus();
                } else {
                    addLog(`âŒ "${doc.name}" ì¸ë±ì‹± ì‹¤íŒ¨: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ ì¸ë±ì‹± ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ì˜ë¯¸ ê²€ìƒ‰ ìˆ˜í–‰
        async function performSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                addLog('âŒ ê²€ìƒ‰ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            if (!window.VectorEngine || !window.VectorEngine.initialized) {
                addLog('âŒ ë²¡í„° ì—”ì§„ì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }

            addLog(`ğŸ” ì˜ë¯¸ ê²€ìƒ‰ ì‹œì‘: "${query}"`, 'info');
            
            try {
                const result = await window.VectorEngine.semanticSearch(query, {
                    topK: 5,
                    minSimilarity: 0.5
                });

                if (result.success) {
                    addLog(`âœ… ì˜ë¯¸ ê²€ìƒ‰ ì™„ë£Œ: ${result.results.length}ê°œ ê²°ê³¼`, 'success');
                    displaySearchResults(result.results, 'search');
                } else {
                    addLog(`âŒ ì˜ë¯¸ ê²€ìƒ‰ ì‹¤íŒ¨: ${result.error}`, 'error');
                }
            } catch (error) {
                addLog(`âŒ ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // RAG ì¿¼ë¦¬ ìˆ˜í–‰
        async function performRAGQuery() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) {
                addLog('âŒ ê²€ìƒ‰ ì§ˆë¬¸ì„ ì…ë ¥í•´ì£¼ì„¸ìš”', 'warning');
                return;
            }

            if (!window.VectorEngine || !window.VectorEngine.initialized) {
                addLog('âŒ ë²¡í„° ì—”ì§„ì´ ì´ˆê¸°í™”ë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }

            addLog(`ğŸ¤– RAG ì¿¼ë¦¬ ì‹œì‘: "${query}"`, 'info');
            
            try {
                // 1. ì˜ë¯¸ ê²€ìƒ‰
                const searchResult = await window.VectorEngine.semanticSearch(query, {
                    topK: 3,
                    minSimilarity: 0.6
                });

                if (searchResult.success && searchResult.results.length > 0) {
                    // 2. RAG ì‘ë‹µ ìƒì„±
                    const ragResponse = await window.VectorEngine.generateRAGResponse(query, searchResult.results);
                    
                    if (ragResponse.success) {
                        addLog(`âœ… RAG ì‘ë‹µ ìƒì„± ì™„ë£Œ (ì»¨í…ìŠ¤íŠ¸: ${ragResponse.contextChunks}ê°œ)`, 'success');
                        displaySearchResults([{
                            response: ragResponse.response,
                            sources: ragResponse.sources,
                            confidence: ragResponse.confidence,
                            type: 'rag'
                        }], 'rag');
                    } else {
                        addLog(`âŒ RAG ì‘ë‹µ ìƒì„± ì‹¤íŒ¨: ${ragResponse.error}`, 'error');
                    }
                } else {
                    addLog('âŒ RAGë¥¼ ìœ„í•œ ê´€ë ¨ ë¬¸ì„œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ', 'warning');
                    displaySearchResults([], 'rag');
                }
            } catch (error) {
                addLog(`âŒ RAG ì¿¼ë¦¬ ì¤‘ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }

        // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
        function displaySearchResults(results, type) {
            const container = document.getElementById('searchResults');
            
            if (results.length === 0) {
                container.innerHTML = '<p style="color: #6c757d; text-align: center;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            let html = '';
            
            if (type === 'rag' && results[0].type === 'rag') {
                // RAG ì‘ë‹µ í‘œì‹œ
                const result = results[0];
                html = `
                    <div class="result-item" style="border-left-color: #28a745;">
                        <strong>ğŸ¤– AI ì‘ë‹µ:</strong>
                        <p style="margin: 10px 0;">${result.response}</p>
                        <div class="result-meta">
                            ì¶œì²˜: ${result.sources.join(', ')} | ì‹ ë¢°ë„: ${(result.confidence * 100).toFixed(1)}%
                        </div>
                    </div>
                `;
            } else {
                // ë²¡í„° ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
                results.forEach((result, index) => {
                    html += `
                        <div class="result-item">
                            <strong>${index + 1}. ${result.documentName}</strong>
                            <p style="margin: 5px 0;">${result.text}</p>
                            <div class="result-meta">
                                ì²­í¬ ID: ${result.chunkId} | ìœ ì‚¬ë„: ${(result.similarity * 100).toFixed(1)}% | 
                                ìœ„ì¹˜: ${result.startPos}-${result.endPos}
                            </div>
                        </div>
                    `;
                });
            }
            
            container.innerHTML = html;
        }

        // ì¸ë±ìŠ¤ ì´ˆê¸°í™”
        async function clearIndex() {
            if (confirm('ì •ë§ë¡œ ëª¨ë“  ë²¡í„° ì¸ë±ìŠ¤ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await window.VectorEngine.clearIndex();
                    addLog('ğŸ—‘ï¸ ë²¡í„° ì¸ë±ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ', 'warning');
                    refreshStatus();
                } catch (error) {
                    addLog(`âŒ ì¸ë±ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨: ${error.message}`, 'error');
                }
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ìë™ ì´ˆê¸°í™”
        window.addEventListener('load', async () => {
            addLog('ğŸŒ í˜ì´ì§€ ë¡œë“œë¨', 'info');
            
            // ë²¡í„° ì—”ì§„ì´ ë¡œë“œë  ë•Œê¹Œì§€ ëŒ€ê¸°
            let attempts = 0;
            while (!window.VectorEngine && attempts < 10) {
                await new Promise(resolve => setTimeout(resolve, 100));
                attempts++;
            }
            
            if (window.VectorEngine) {
                addLog('âœ… ë²¡í„° ì—”ì§„ ë¡œë“œë¨', 'success');
                await initializeEngine();
            } else {
                addLog('âŒ ë²¡í„° ì—”ì§„ ë¡œë“œ ì‹¤íŒ¨', 'error');
            }
        });

        // ì—”í„° í‚¤ ê²€ìƒ‰ ì§€ì›
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
    </script>
</body>
</html>